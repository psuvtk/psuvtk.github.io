<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-cn">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>I2C总线 - Early is on Time</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO
软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START // 确保总线空闲 // HOW TO us_delay(4); // 额外的 SDA=1;SCL=1; // 是否需要延时？延时多少 // START 符号 SDA=0;SCL=1; // T_hd;sta &gt; 4.0 us us_delay(4); SDA=0;SCL=0; 发送 // T_low &gt; 4.7, T_high &gt; 4.0us SCL = 0; us_delay(5); // 数据 SDA = xx; // T_su;dat &gt; 250ns us_delay(1); // 拉高SCL SCL = 1; // T_high &gt; 4.0us us_delay(4); // 拉低SCL SCL = 0; // T_high &gt; 4." /><meta name="keywords" content='Hugo, FixIt' />
  <meta itemprop="name" content="I2C总线">
  <meta itemprop="description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO
软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START // 确保总线空闲 // HOW TO us_delay(4); // 额外的 SDA=1;SCL=1; // 是否需要延时？延时多少 // START 符号 SDA=0;SCL=1; // T_hd;sta &gt; 4.0 us us_delay(4); SDA=0;SCL=0; 发送 // T_low &gt; 4.7, T_high &gt; 4.0us SCL = 0; us_delay(5); // 数据 SDA = xx; // T_su;dat &gt; 250ns us_delay(1); // 拉高SCL SCL = 1; // T_high &gt; 4.0us us_delay(4); // 拉低SCL SCL = 0; // T_high &gt; 4.">
  <meta itemprop="datePublished" content="2022-10-19T20:18:47+08:00">
  <meta itemprop="dateModified" content="2022-10-19T20:18:47+08:00">
  <meta itemprop="wordCount" content="3976"><meta property="og:url" content="http://localhost:1313/posts/11.-i2c%E6%80%BB%E7%BA%BF/">
  <meta property="og:site_name" content="Early is on Time">
  <meta property="og:title" content="I2C总线">
  <meta property="og:description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO
软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START // 确保总线空闲 // HOW TO us_delay(4); // 额外的 SDA=1;SCL=1; // 是否需要延时？延时多少 // START 符号 SDA=0;SCL=1; // T_hd;sta &gt; 4.0 us us_delay(4); SDA=0;SCL=0; 发送 // T_low &gt; 4.7, T_high &gt; 4.0us SCL = 0; us_delay(5); // 数据 SDA = xx; // T_su;dat &gt; 250ns us_delay(1); // 拉高SCL SCL = 1; // T_high &gt; 4.0us us_delay(4); // 拉低SCL SCL = 0; // T_high &gt; 4.">
  <meta property="og:locale" content="zh_cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-10-19T20:18:47+08:00">
    <meta property="article:modified_time" content="2022-10-19T20:18:47+08:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="I2C总线">
  <meta name="twitter:description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO
软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START // 确保总线空闲 // HOW TO us_delay(4); // 额外的 SDA=1;SCL=1; // 是否需要延时？延时多少 // START 符号 SDA=0;SCL=1; // T_hd;sta &gt; 4.0 us us_delay(4); SDA=0;SCL=0; 发送 // T_low &gt; 4.7, T_high &gt; 4.0us SCL = 0; us_delay(5); // 数据 SDA = xx; // T_su;dat &gt; 250ns us_delay(1); // 拉高SCL SCL = 1; // T_high &gt; 4.0us us_delay(4); // 拉低SCL SCL = 0; // T_high &gt; 4.">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://localhost:1313/posts/11.-i2c%E6%80%BB%E7%BA%BF/" /><link rel="prev" href="http://localhost:1313/posts/10.-%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/" /><link rel="next" href="http://localhost:1313/posts/12.-lua/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "I2C总线",
    "inLanguage": "zh-cn",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/localhost:1313\/posts\/11.-i2c%E6%80%BB%E7%BA%BF\/"
    },"genre": "posts","wordcount":  3976 ,
    "url": "http:\/\/localhost:1313\/posts\/11.-i2c%E6%80%BB%E7%BA%BF\/","datePublished": "2022-10-19T20:18:47+08:00","dateModified": "2022-10-19T20:18:47+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Author"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="Early is on Time"><img loading="lazy" src="/fixit.min.svg" srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" sizes="auto" data-title="Early is on Time" data-alt="Early is on Time" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Kristoffer&#39;s Blog</span></a><span class="header-subtitle">early is on time</span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/"
                
                
              >首页</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/posts"
                
                
              >文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/life"
                
                
              >生活</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/algo"
                
                
              >面经</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/about"
                
                
              >本人</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="Early is on Time"><img loading="lazy" src="/fixit.min.svg" srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" sizes="auto" data-title="/fixit.min.svg" data-alt="/fixit.min.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">Kristoffer&#39;s Blog</span></a><span class="header-subtitle">early is on time</span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/"
                  
                  
                >首页</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts"
                  
                  
                >文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/life"
                  
                  
                >生活</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/algo"
                  
                  
                >面经</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/about"
                  
                  
                >本人</a></li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span>I2C总线</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Anonymous</span></span></div>
      <div class="post-meta-line"><span title=2022-10-19&#32;20:18:47><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-10-19">2022-10-19</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 3976 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 19 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#heading"></a></li>
    <li><a href="#时钟延展">时钟延展</a></li>
    <li><a href="#总线挂死">总线挂死</a></li>
    <li><a href="#i2c子系统-linux内核实现">I2C子系统 Linux内核实现</a></li>
    <li><a href="#软件模拟i2c-mastergpio模拟">软件模拟I2C Master(GPIO模拟)</a>
      <ul>
        <li><a href="#检测总线是否空闲">检测总线是否空闲</a></li>
        <li><a href="#发送start">发送START</a></li>
      </ul>
    </li>
    <li><a href="#发送">发送</a></li>
    <li><a href="#停止">停止</a></li>
    <li><a href="#gpio-模式配置stgd">GPIO 模式配置(ST/GD)</a>
      <ul>
        <li><a href="#为什么不能直接使用芯片内部的上拉电阻">为什么不能直接使用芯片内部的上拉电阻</a></li>
      </ul>
    </li>
    <li><a href="#i2c-slave">I2C Slave</a>
      <ul>
        <li><a href="#ti-参考代码">TI 参考代码</a></li>
      </ul>
    </li>
    <li><a href="#linux-i2c-驱动">Linux I2C 驱动</a>
      <ul>
        <li><a href="#gpio-模拟">GPIO 模拟</a></li>
      </ul>
    </li>
    <li><a href="#学习文档">学习文档</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="heading"></h2>
<h2 id="时钟延展">时钟延展</h2>
<h2 id="总线挂死">总线挂死</h2>
<h2 id="i2c子系统-linux内核实现">I2C子系统 Linux内核实现</h2>
<p>TODO</p>
<h2 id="软件模拟i2c-mastergpio模拟">软件模拟I2C Master(GPIO模拟)</h2>
<h3 id="检测总线是否空闲">检测总线是否空闲</h3>
<h3 id="发送start">发送START</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// 确保总线空闲
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// HOW TO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">4</span>); <span style="color:#75715e">// 额外的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 是否需要延时？延时多少
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// START 符号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// T_hd;sta &gt; 4.0 us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p><img loading="lazy" src="../../images/i2c_start.png" srcset="../../images/i2c_start.png, ../../images/i2c_start.png 1.5x, ../../images/i2c_start.png 2x" sizes="auto" data-title="I2C_START.png" data-alt="I2C_START.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="发送">发送</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// T_low &gt; 4.7, T_high &gt; 4.0us 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SCL <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SDA <span style="color:#f92672">=</span> xx;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// T_su;dat &gt; 250ns
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 拉高SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SCL <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// T_high &gt; 4.0us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 拉低SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SCL <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// T_high &gt; 4.0us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><h2 id="停止">停止</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// T_su;sto &gt; 4.0us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// T_hd;dat
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">us_delay</span>(<span style="color:#ae81ff">5</span>);
</span></span></code></pre></div><p><img loading="lazy" src="../../images/i2c_stop.png" srcset="../../images/i2c_stop.png, ../../images/i2c_stop.png 1.5x, ../../images/i2c_stop.png 2x" sizes="auto" data-title="I2C_START.png" data-alt="I2C_START.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h2 id="gpio-模式配置stgd">GPIO 模式配置(ST/GD)</h2>
<ul>
<li>
<p>输入</p>
<ul>
<li>浮空输入</li>
</ul>
</li>
<li>
<p>输出</p>
<ul>
<li>开漏输出模式</li>
<li>NOPULL 模式</li>
<li>FREQ HIGH模式</li>
</ul>
</li>
</ul>
<p>GD32、STM32在GPIO 输出配置章节有如下描述;</p>
<pre tabindex="0"><code>开漏模式：输出控制寄存器设置为“0”时，相应引脚输出低电平；输出控制寄存器设置 为
“1”，相应管脚处于高阻状态；
</code></pre><h3 id="为什么不能直接使用芯片内部的上拉电阻">为什么不能直接使用芯片内部的上拉电阻</h3>
<p>内部实现的是弱上拉(40K Ohm), 不满足时序要求；
外部上拉电阻一般使用4.7K Ohm;</p>
<h2 id="i2c-slave">I2C Slave</h2>
<p><img loading="lazy" src="../../images/i2c_slave_fsm.png" srcset="../../images/i2c_slave_fsm.png, ../../images/i2c_slave_fsm.png 1.5x, ../../images/i2c_slave_fsm.png 2x" sizes="auto" data-title="i2c_slave_fsm.png" data-alt="i2c_slave_fsm.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<h3 id="ti-参考代码">TI 参考代码</h3>
<ul>
<li>fr2111_swi2c_master.h</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* --COPYRIGHT--,BSD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Copyright (c) 2016, Texas Instruments Incorporated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * All rights reserved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Redistribution and use in source and binary forms, with or without
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * modification, are permitted provided that the following conditions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * are met:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Redistributions of source code must retain the above copyright
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Redistributions in binary form must reproduce the above copyright
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    documentation and/or other materials provided with the distribution.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    its contributors may be used to endorse or promote products derived
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    from this software without specific prior written permission.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * --/COPYRIGHT--*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;msp430.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Pin Definitions. These  should be changed depending on the device that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * you are using.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_SCL         BIT3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_SDA         BIT2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_PxDIR       P1DIR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_PxOUT       P1OUT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_PxIN        P1IN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_SDA_LOW     SWI2C_PxDIR |= SWI2C_SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_SCL_LOW     SWI2C_PxDIR |= SWI2C_SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_SCL_HIGH    SWI2C_PxDIR &amp;= ~SWI2C_SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_SDA_HIGH    SWI2C_PxDIR &amp;= ~SWI2C_SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Defines the buffer size to be used. This will change depending on your
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * application and the size requirements for the transfer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Configuration structure for performing an I2C transaction */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _SWI2C_I2CTransaction
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span>             address;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint_fast16_t</span>       numWriteBytes;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span><span style="color:#f92672">*</span>            writeBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint_fast16_t</span>       numReadBytes;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint8_t</span><span style="color:#f92672">*</span>            readBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span>                repeatedStart;
</span></span><span style="display:flex;"><span>} SWI2C_I2CTransaction;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Timer period for determining the clock rate of the I2C data clock. Note that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * the timer is sourced from SMCLK and that this number is equal to the duration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * of roughly HALF a clock period. For example, if SMCLK is set to 3MHz and the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * period below is set to 15, we would end up with an I2C data rate of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * approximately 100Khz.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * In short, the I2C data rate frequency can be calculated by:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * I2C Data Rate =      SMCLK Frequency
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *                    ___________________
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *                      2 * TimerPeriod
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SWI2C_TIMER_PERIOD  15
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Macro for a timer iteration */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define TIMER_ITERATION()            TB0CCTL0 &amp;= ~(CCIFG);           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                                     while(!(TB0CCTL0 &amp; CCIFG));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Function Prototypes */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! Initializes the software I2C master. This function takes the port
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! definitions that are given above and configures the device for software
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! I2C operation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \return None
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SWI2C_initI2C</span>(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! Starts an I2C transaction over the configured I2C master device. Note that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! this function is blocking until the transaction is completed. If a timeout
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! feature is required, the user should use the watchdog module of their MCU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! in tandem with this function. Since the I2C slave has the ability to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! &#34;clock stretch&#34; the module, care has to be taken to manage the real time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!  behavior of the main application.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! &lt;hr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! &lt;b&gt;Configuration options for \link SWI2C_I2CTransaction \endlink structure.&lt;/b&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! &lt;hr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \param address I2C Slave Address to communicate with.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \param numWriteBytes Number of bytes for the master to write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \param writeBuffer Pointer to the buffer to write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \param numReadBytes Number of bytes to read
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \param readBuffer Pointer to the buffer to read values into
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \param repeatedStart In the event that both a read and write operation are
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!         requested, this bool value determines if a repeated start coniditon
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!         is sent out over the bus. If set to true, no I2C STOP is sent out
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!         after the write transaction. If set to false. After the write
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!         transaction completes an I2C STOP condition is sent out, and then
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!         the I2C read transaction is treated as a completely separate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!         transaction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! Note that any order of combinations can be passed into the transaction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! structure. If the user wants to only perform an I2C read, then only the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! read parameters should be populated and the write parameters should be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! set to 0 (or vice versa for write). The user can also specify both read
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! and write bytes and use the repeatedStart parameter to specify if there
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! is an I2C STOP between the transactions. Note that the write transaction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! is always first when using this function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//! \return true if the operation passed, false otherwise. A false return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//!     value means that the device received a NAK where one was not expected.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_performI2CTransaction</span>(SWI2C_I2CTransaction <span style="color:#f92672">*</span>i2cTransaction);
</span></span></code></pre></div><ul>
<li>fr2111_swi2c_master.c</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* --COPYRIGHT--,BSD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Copyright (c) 2016, Texas Instruments Incorporated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * All rights reserved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Redistribution and use in source and binary forms, with or without
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * modification, are permitted provided that the following conditions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * are met:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Redistributions of source code must retain the above copyright
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Redistributions in binary form must reproduce the above copyright
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    documentation and/or other materials provided with the distribution.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    its contributors may be used to endorse or promote products derived
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    from this software without specific prior written permission.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * --/COPYRIGHT--*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;fr2111_swi2c_master.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Static Functions */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_readData</span>(<span style="color:#66d9ef">uint8_t</span> addr,  <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>inputArray,
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">uint_fast16_t</span> size);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_writeData</span>(<span style="color:#66d9ef">uint8_t</span> addr, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>outputArray, 
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">uint_fast16_t</span> size, <span style="color:#66d9ef">bool</span> sendStop);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SWI2C_initI2C</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Using the direction pin to control the output. When set as an input, the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        hardware pull-ups will take over and cause the pin to go high. When
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        set as an output, the MSP430 will drive the lines low */</span>
</span></span><span style="display:flex;"><span>    SWI2C_PxOUT <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(SWI2C_SCL <span style="color:#f92672">|</span> SWI2C_SDA);
</span></span><span style="display:flex;"><span>    SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>    SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    PM5CTL0 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>LOCKLPM5;                   <span style="color:#75715e">// Disable the GPIO power-on default high-impedance mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                            <span style="color:#75715e">// to activate previously configured port settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Timer is initialized to run off SMCLK(8MHz) with frequency 200KHz */</span>
</span></span><span style="display:flex;"><span>    TB0CCR0 <span style="color:#f92672">=</span> SWI2C_TIMER_PERIOD;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_performI2CTransaction</span>(SWI2C_I2CTransaction <span style="color:#f92672">*</span>i2cTransaction)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>numWriteBytes <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Only skipping the stop if we have a repeated start to send */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>repeatedStart <span style="color:#f92672">&amp;&amp;</span> i2cTransaction<span style="color:#f92672">-&gt;</span>numReadBytes <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">SWI2C_writeData</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>address,
</span></span><span style="display:flex;"><span>                    i2cTransaction<span style="color:#f92672">-&gt;</span>writeBuffer, i2cTransaction<span style="color:#f92672">-&gt;</span>numWriteBytes,
</span></span><span style="display:flex;"><span>                    false))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">SWI2C_writeData</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>address,
</span></span><span style="display:flex;"><span>                    i2cTransaction<span style="color:#f92672">-&gt;</span>writeBuffer, i2cTransaction<span style="color:#f92672">-&gt;</span>numWriteBytes,
</span></span><span style="display:flex;"><span>                    true))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Next doing the read */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i2cTransaction<span style="color:#f92672">-&gt;</span>numReadBytes <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">SWI2C_readData</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>address, i2cTransaction<span style="color:#f92672">-&gt;</span>readBuffer,
</span></span><span style="display:flex;"><span>                i2cTransaction<span style="color:#f92672">-&gt;</span>numReadBytes))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_writeData</span>(<span style="color:#66d9ef">uint8_t</span> addr, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>outputArray, 
</span></span><span style="display:flex;"><span>                                <span style="color:#66d9ef">uint_fast16_t</span> size, <span style="color:#66d9ef">bool</span> sendStop)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint_fast8_t</span> bits, temp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> ii <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Starting the timer */</span>
</span></span><span style="display:flex;"><span>    TB0CTL <span style="color:#f92672">=</span> TBSSEL_2 <span style="color:#f92672">+</span> MC_1 <span style="color:#f92672">+</span> TBCLR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Sending the START */</span>
</span></span><span style="display:flex;"><span>    SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__no_operation</span>();
</span></span><span style="display:flex;"><span>    SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Next doing the control byte */</span>
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Loop until all bits of the address byte are sent out */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Deciding if we want to send a high or low out of the line */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">&amp;</span> BIT7) 
</span></span><span style="display:flex;"><span>        {                  
</span></span><span style="display:flex;"><span>            SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>        }                 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Now that we set the SDA line, we have to send out a clock pulse */</span>
</span></span><span style="display:flex;"><span>        SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Incrementing to the next bit and waiting for the next clock cycle */</span>
</span></span><span style="display:flex;"><span>        temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Detecting if we have a NAK on the bus. If the slave device NAKed the 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        control byte, it probably isn&#39;t there on the bus so we should send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         an I2C stop and return false */</span>
</span></span><span style="display:flex;"><span>    SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>    SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> I2CWriteTransactionCleanUp;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Sending out another clock cycle */</span>
</span></span><span style="display:flex;"><span>    SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Next, let us send out all bytes in the user buffer */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(ii<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;ii<span style="color:#f92672">&lt;</span>size;ii<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        temp <span style="color:#f92672">=</span> outputArray[ii];
</span></span><span style="display:flex;"><span>        bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Loop until all bits of the current byte are sent out */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Deciding if we want to send a high or low out of the line */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">&amp;</span> BIT7) 
</span></span><span style="display:flex;"><span>            {                  
</span></span><span style="display:flex;"><span>                SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>            }                 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Now that we set the SDA line, we send out a clock pulse */</span>
</span></span><span style="display:flex;"><span>            SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Incrementing to the next bit and waiting for next clock cycle */</span>
</span></span><span style="display:flex;"><span>            temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Detecting the NAK. We should break out of the send loop */</span>
</span></span><span style="display:flex;"><span>        SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>        SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> I2CWriteTransactionCleanUp;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Sending out another clock cycle */</span>
</span></span><span style="display:flex;"><span>        SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I2CWriteTransactionCleanUp:    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* If the user did not request to skip, we send out the stop bit */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>((sendStop <span style="color:#f92672">&amp;&amp;</span> ii <span style="color:#f92672">==</span> size) <span style="color:#f92672">||</span> (ii <span style="color:#f92672">!=</span> size))
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>        SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>        SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">__no_operation</span>();
</span></span><span style="display:flex;"><span>        SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>        SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Stop the timer */</span>
</span></span><span style="display:flex;"><span>    TB0CTL <span style="color:#f92672">=</span> MC_0;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* If all bytes were sent, return true- otherwise false. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(ii <span style="color:#f92672">==</span> size)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_readData</span>(<span style="color:#66d9ef">uint8_t</span> addr, <span style="color:#66d9ef">uint8_t</span> <span style="color:#f92672">*</span>inputArray, 
</span></span><span style="display:flex;"><span>                            <span style="color:#66d9ef">uint_fast16_t</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint_fast8_t</span> bits, temp;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint16_t</span> ii <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Starting the timer */</span>
</span></span><span style="display:flex;"><span>    TB0CTL <span style="color:#f92672">=</span> TBSSEL_2 <span style="color:#f92672">+</span> MC_1 <span style="color:#f92672">+</span> TBCLR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Sending the START */</span>
</span></span><span style="display:flex;"><span>    SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__no_operation</span>();
</span></span><span style="display:flex;"><span>    SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Next doing the control byte */</span>
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> BIT0;
</span></span><span style="display:flex;"><span>    bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Loop until all bits of the address byte are sent out */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Deciding if we want to send a high or low out of the line */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">&amp;</span> BIT7) 
</span></span><span style="display:flex;"><span>        {                  
</span></span><span style="display:flex;"><span>            SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>        }                 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Now that we set the SDA line, we have to send out a clock pulse */</span>
</span></span><span style="display:flex;"><span>        SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Incrementing to the next bit and waiting for the next clock cycle */</span>
</span></span><span style="display:flex;"><span>        temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Detecting if we have a NAK on the bus. If the slave device NAKed the 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        control byte, it probably isn&#39;t there on the bus so we should send
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         an I2C stop and return false */</span>
</span></span><span style="display:flex;"><span>    SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>    SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> I2CReadTransactionCleanUp;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Next, we want to read out all of the data requested */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(ii<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;ii<span style="color:#f92672">&lt;</span>size;ii<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Setup the read variables */</span>
</span></span><span style="display:flex;"><span>        temp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">/* Sending out another clock cycle */</span>
</span></span><span style="display:flex;"><span>         SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>         SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Loop to read until all bits have been read */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Priming our temporary variable and sending a clock pulse */</span>
</span></span><span style="display:flex;"><span>            temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* If the data line is high, recording that */</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA) 
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              temp <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* Send out another clock cycle and decrement our counter */</span>
</span></span><span style="display:flex;"><span>            bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Storing the data off */</span>
</span></span><span style="display:flex;"><span>        inputArray[ii] <span style="color:#f92672">=</span> temp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* Now the master needs to send out the ACK */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(ii <span style="color:#f92672">==</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>            SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        	SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>        SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>I2CReadTransactionCleanUp:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Sending out the stop bit */</span>
</span></span><span style="display:flex;"><span>    SWI2C_SCL_LOW;
</span></span><span style="display:flex;"><span>    SWI2C_SDA_LOW;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>    SWI2C_SCL_HIGH;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__no_operation</span>();
</span></span><span style="display:flex;"><span>    SWI2C_SDA_HIGH;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">TIMER_ITERATION</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* Stop the timer */</span>
</span></span><span style="display:flex;"><span>    TB0CTL <span style="color:#f92672">=</span> MC_0;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* If all bytes were read, return true- otherwise false. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(ii <span style="color:#f92672">==</span> size)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>FR2111_SW_I2C_Slave.c</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* --COPYRIGHT--,BSD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Copyright (c) 2016, Texas Instruments Incorporated
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * All rights reserved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Redistribution and use in source and binary forms, with or without
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * modification, are permitted provided that the following conditions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * are met:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Redistributions of source code must retain the above copyright
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Redistributions in binary form must reproduce the above copyright
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer in the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    documentation and/or other materials provided with the distribution.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    its contributors may be used to endorse or promote products derived
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *    from this software without specific prior written permission.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * --/COPYRIGHT--*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//*****************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  MSP430FR2111 Software I2C Slave
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  Description: This demo connects two MSP430&#39;s via the I2C bus. The master is
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  MSP430FR2311 with hardware I2C(eUSCI_B0). The slave is MSP430FR2111 using GPIOs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  to implement software I2C. The master write to and read from the slave.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  This is the slave code.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//  MCLK = SMCLK = 8MHz.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//    *****used with &#34;FR2311_HW_I2C_Master.c&#34;****
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                                /|\  /|\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//               MSP430FR2311      10k  10k     MSP430FR2111
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                   master         |    |        slave
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//             -----------------   |    |   -----------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            |     P1.2/UCB0SDA|&lt;-|----|-&gt;|P2.0(SW I2C)     |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            |                 |  |       |                 |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            |                 |  |       |                 |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            |     P1.3/UCB0SCL|&lt;-|------&gt;|P1.0(SW I2C)     |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//            |                 |          |                 |
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   Texas Instruments Inc.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   June. 2016
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//******************************************************************************
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;msp430.h&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SCL BIT0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SDA BIT0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define I2COA 0x0A               </span><span style="color:#75715e">// Slave address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define I2C_START     1          </span><span style="color:#75715e">// Start condition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define I2C_STOP      2          </span><span style="color:#75715e">// Stop condition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W1LH      3          </span><span style="color:#75715e">// Bit 1 (first clk rising edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W1HL      4          </span><span style="color:#75715e">// Bit 1 (first clk falling edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W2to6LH   5          </span><span style="color:#75715e">// Bit 2-6(2nd~6th  clk rising edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W7LH      6          </span><span style="color:#75715e">// Bit 7 (7th  clk rising edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W8LH      7          </span><span style="color:#75715e">// Bit 8 (8th  clk rising edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W8HL      8          </span><span style="color:#75715e">// Set ACK (8th  clk falling edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W9HL      9          </span><span style="color:#75715e">// Re-init R4 (9th  clk falling edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R1HL      10         </span><span style="color:#75715e">// Bit 1 (first clk falling edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R1LH      11         </span><span style="color:#75715e">// Bit 1 (first clk rising edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R2to8HL   12         </span><span style="color:#75715e">// Bit 2-8 (2nd~8th clk falling edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R9HL      13         </span><span style="color:#75715e">// Free SDA (9th clk falling edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R9LH      14         </span><span style="color:#75715e">// Check ACK (9th clk rising edge)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define MCLK_FREQ_MHZ 8          </span><span style="color:#75715e">// MCLK = 8MHz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> ram_data[<span style="color:#ae81ff">16</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> I2C_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> cnt_2to6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> cnt_2to8<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> RW_flag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> ram_cnt<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitBuffer</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">INIT_PORT</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Software_Trim</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>	WDTCTL <span style="color:#f92672">=</span> WDTPW <span style="color:#f92672">|</span> WDTHOLD;	            <span style="color:#75715e">// Stop watchdog timer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__bis_SR_register</span>(SCG0);                <span style="color:#75715e">// Disable FLL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CSCTL3 <span style="color:#f92672">=</span> SELREF__REFOCLK;               <span style="color:#75715e">// Set REFO as FLL reference source
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CSCTL1 <span style="color:#f92672">=</span> DCOFTRIMEN_1 <span style="color:#f92672">|</span> DCOFTRIM0 <span style="color:#f92672">|</span> DCOFTRIM1 <span style="color:#f92672">|</span> DCORSEL_3;<span style="color:#75715e">// DCOFTRIM=3, DCO Range = 8MHz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CSCTL2 <span style="color:#f92672">=</span> FLLD_0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">243</span>;                  <span style="color:#75715e">// DCODIV = 8MHz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">__delay_cycles</span>(<span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__bic_SR_register</span>(SCG0);                <span style="color:#75715e">// Enable FLL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Software_Trim</span>();                        <span style="color:#75715e">// Software Trim to get the best DCOFTRIM value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    CSCTL4 <span style="color:#f92672">=</span> SELMS__DCOCLKDIV <span style="color:#f92672">|</span> SELA__REFOCLK; <span style="color:#75715e">// set default REFO(~32768Hz) as ACLK source, ACLK = 32768Hz
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                               <span style="color:#75715e">// default DCODIV as MCLK and SMCLK source
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">InitBuffer</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">INIT_PORT</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__enable_interrupt</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitBuffer</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> i;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		ram_data[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Set SCL and SDA to inputs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// SDA interrupts on high-to-low transition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// SCL interrupts on low-to-high transition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// initially, just SDA interrupt is set
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">INIT_PORT</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	P2OUT <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;    <span style="color:#75715e">// When the pins are set to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P1OUT <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// output, low level should be seen
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P1DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// SCL and SDA defined as inputs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;
</span></span><span style="display:flex;"><span>	P2IES <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">//INT. on high-to-low transition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// INT. on low-to-high transition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P1IE  <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Disable SCL interrupt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P2IE  <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">// Enable SDA interrupt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Reset interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	PM5CTL0 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>LOCKLPM5;  <span style="color:#75715e">// Disable the GPIO power-on default high-impedance mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	                       <span style="color:#75715e">// to activate previously configured port settings
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SDA(Port 2) interrupt service routine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Port 2 ISR, check Start or Stop condition from P2.0 and P1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Or it can check I/O interrupt from other P2 pins with interrupt function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma vector=PORT2_VECTOR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>__interrupt <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Port_2</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__GNUC__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__attribute__</span> ((<span style="color:#a6e22e">interrupt</span>(PORT2_VECTOR))) <span style="color:#a6e22e">Port_2</span> (<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#error Compiler not supported!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>((P1IN <span style="color:#f92672">&amp;</span> SCL <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span> (P2IFG <span style="color:#f92672">&amp;</span> SDA <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span> (P2IES <span style="color:#f92672">&amp;</span> SDA <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		I2C_state <span style="color:#f92672">=</span> I2C_START; <span style="color:#75715e">// I2C start condition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		I2C_state <span style="color:#f92672">=</span> I2C_STOP;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	P2IFG <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;          <span style="color:#75715e">// Clear INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span>(I2C_state)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> I2C_START:
</span></span><span style="display:flex;"><span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;  <span style="color:#75715e">// P1.0 clear INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IE <span style="color:#f92672">|=</span> SCL;    <span style="color:#75715e">// P1.0 INT enable for SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;  <span style="color:#75715e">// P2.0 set to rising edge for SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;  <span style="color:#75715e">// P2.0 clear INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SDA;  <span style="color:#75715e">// P2.0 INT disable for SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W1LH;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> I2C_STOP:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">INIT_PORT</span>();
</span></span><span style="display:flex;"><span>		i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;   <span style="color:#75715e">// Reset I2CDATA for addr detect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset RW_flag for addr detect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ram_cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset buffer pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SCL(Port 1) interrupt service routine
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma vector=PORT1_VECTOR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>__interrupt <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Port_1</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(__GNUC__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__attribute__</span> ((<span style="color:#a6e22e">interrupt</span>(PORT1_VECTOR))) <span style="color:#a6e22e">Port_1</span> (<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#error Compiler not supported!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span>(I2C_state)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W1LH:
</span></span><span style="display:flex;"><span>		P1IES <span style="color:#f92672">|=</span> SCL;      <span style="color:#75715e">// Set falling edge for SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)     <span style="color:#75715e">// Check SDA and update i2c_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// Shift SDA bit into the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset SCL interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;     <span style="color:#75715e">// Clear flag, FOR STP_CON DETECT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">|=</span> SDA;       <span style="color:#75715e">// Enable SDA INT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W1HL;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W1HL:
</span></span><span style="display:flex;"><span>		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SCL;    <span style="color:#75715e">// Set rising edge for SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset SCL interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;      <span style="color:#75715e">// 1st FALLING SCL TO disable SDA INT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W2to6LH;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W2to6LH:
</span></span><span style="display:flex;"><span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)     <span style="color:#75715e">// Check SDA and and update i2c_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			i2c_data<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(cnt_2to6 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>)   <span style="color:#75715e">// 5bits(bit2 to bit6)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			cnt_2to6<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			cnt_2to6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// Reset counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			I2C_state <span style="color:#f92672">=</span> SCL_W7LH;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W7LH:
</span></span><span style="display:flex;"><span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)     <span style="color:#75715e">// Check SDA and and update i2c_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		{
</span></span><span style="display:flex;"><span>			i2c_data<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>((RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (i2c_data <span style="color:#f92672">!=</span> I2COA) )
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> I2C_STOP;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> SCL_W8LH;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W8LH:
</span></span><span style="display:flex;"><span>		P1IES <span style="color:#f92672">|=</span> SCL;        <span style="color:#75715e">// Set falling edge for SCL.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;       <span style="color:#75715e">// Reset interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)   <span style="color:#75715e">// Check SDA and and update i2c_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// Read CMD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>				RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; <span style="color:#75715e">// Write CMD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)   <span style="color:#75715e">// Check SDA and and update i2c_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				i2c_data<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		I2C_state <span style="color:#f92672">=</span> SCL_W8HL;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W8HL:
</span></span><span style="display:flex;"><span>		P2DIR <span style="color:#f92672">|=</span> SDA;        <span style="color:#75715e">// Output &#34;0&#34; for SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;       <span style="color:#75715e">//Reset SCL interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			i2c_data <span style="color:#f92672">=</span> ram_data[ram_cnt];
</span></span><span style="display:flex;"><span>			ram_cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>            ram_cnt <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x0f</span>;
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> SCL_R1HL;<span style="color:#75715e">// Go to read state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> SCL_W9HL;<span style="color:#75715e">// Go to write state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			ram_data[ram_cnt] <span style="color:#f92672">=</span> i2c_data;
</span></span><span style="display:flex;"><span>			ram_cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>            ram_cnt <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x0f</span>;
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> SCL_W9HL;<span style="color:#75715e">// Go to write state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> I2C_STOP;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_W9HL:
</span></span><span style="display:flex;"><span>		P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;        <span style="color:#75715e">// Release SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Set rising edge for SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Reset interrupt flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W1LH;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_R1HL:
</span></span><span style="display:flex;"><span>		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Set rising edge SCL for SCL_R1LH
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(i2c_data <span style="color:#f92672">&amp;</span> BIT7)
</span></span><span style="display:flex;"><span>			P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;    <span style="color:#75715e">// SDA = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			P2DIR <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">// SDA = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SCL;       <span style="color:#75715e">// Clear SCL INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IE  <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SDA;       <span style="color:#75715e">// Disable SDA INT, NO STP CON
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_R1LH;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_R1LH:
</span></span><span style="display:flex;"><span>		P1IES <span style="color:#f92672">|=</span> SCL;         <span style="color:#75715e">// Set falling edge for SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Clear SCL INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;        <span style="color:#75715e">// Clear SDA INT Flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">|=</span> SDA;          <span style="color:#75715e">// Enable SDA INT for STOP CON
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_R2to8HL;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_R2to8HL:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(i2c_data <span style="color:#f92672">&amp;</span> BIT7)
</span></span><span style="display:flex;"><span>			P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;    <span style="color:#75715e">// SDA = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			P2DIR <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">// SDA = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SCL;       <span style="color:#75715e">// Clear SCL INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P2IE  <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SDA;       <span style="color:#75715e">// Disable SDA INT, NO STP CON
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(cnt_2to8 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			cnt_2to8<span style="color:#f92672">++</span>;       <span style="color:#75715e">// 7bits(bit2 to bit8)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			cnt_2to8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;     <span style="color:#75715e">// Clear counter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			I2C_state <span style="color:#f92672">=</span> SCL_R9HL;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_R9HL:
</span></span><span style="display:flex;"><span>		P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;        <span style="color:#75715e">// Release SDA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Set Rising edge of SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Clear SCL INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_R9LH;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> SCL_R9LH:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)        <span style="color:#75715e">// NACK_READ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		{
</span></span><span style="display:flex;"><span>			P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Set rising edge of SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Clear SCL INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			I2C_state <span style="color:#f92672">=</span> SCL_W1LH; <span style="color:#75715e">// Go to SCL_W1LH to detect stop condition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>                  <span style="color:#75715e">// ACK_READ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		{
</span></span><span style="display:flex;"><span>			P1IES <span style="color:#f92672">|=</span> SCL;     <span style="color:#75715e">// Set falling edge of SCL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Clear SCL INT flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			i2c_data <span style="color:#f92672">=</span> ram_data[ram_cnt]; <span style="color:#75715e">// Move out next byte from RAM buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			ram_cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>			ram_cnt <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x0f</span>;
</span></span><span style="display:flex;"><span>			I2C_state <span style="color:#f92672">=</span> SCL_R1HL;<span style="color:#75715e">// Go to read state
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> I2C_STOP:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">INIT_PORT</span>();
</span></span><span style="display:flex;"><span>		i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;   <span style="color:#75715e">// Reset I2CDATA for addr detect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset RW_flag for addr detect
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ram_cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset buffer pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="linux-i2c-驱动">Linux I2C 驱动</h2>
<h3 id="gpio-模拟">GPIO 模拟</h3>
<p>算法: linux-6.1-rc2\drivers\i2c\algos\i2c-algo-bit.c
总线: linux-6.1-rc2\drivers\i2c\busses\i2c-gpio.c</p>
<h2 id="学习文档">学习文档</h2>
<ol>
<li>UM10204(I2C-bus specification and user manual) Texas Instruments</li>
<li>SPRABJ6(Software Implementation of PMBus Over I2C for TMS320F2803x)</li>
<li>从机状态机: SLAA703A(Software I2C on MSP430™ MCUs)</li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-10-19&#32;20:18:47>Updated on 2022-10-19&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/posts/11.-i2c%E6%80%BB%E7%BA%BF/" data-title="I2C总线"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/posts/11.-i2c%E6%80%BB%E7%BA%BF/"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/posts/11.-i2c%E6%80%BB%E7%BA%BF/" data-title="I2C总线"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/10.-%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/" class="post-nav-item" rel="prev" title="SPI总线"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>SPI总线</a>
      <a href="/posts/12.-lua/" class="post-nav-item" rel="next" title="Lua">Lua<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.2">Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-RC"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">Theme FixIt works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
