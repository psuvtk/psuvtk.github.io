<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> I2C总线 | 浅尝辄止</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="I2C总线" />
<meta property="og:description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO
软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START // 确保总线空闲 // HOW TO us_delay(4); // 额外的  SDA=1;SCL=1; // 是否需要延时？延时多少  // START 符号 SDA=0;SCL=1; // T_hd;sta &gt; 4.0 us us_delay(4); SDA=0;SCL=0; 发送 // T_low &gt; 4.7, T_high &gt; 4.0us SCL = 0; us_delay(5); // 数据 SDA = xx; // T_su;dat &gt; 250ns us_delay(1); // 拉高SCL SCL = 1; // T_high &gt; 4.0us us_delay(4); // 拉低SCL SCL = 0; // T_high &gt; 4." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://psuvtk.github.io/posts/11.-i2c%E6%80%BB%E7%BA%BF/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-19T20:18:47&#43;08:00" />
<meta property="article:modified_time" content="2022-10-19T20:18:47&#43;08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="I2C总线"/>
<meta name="twitter:description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO
软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START // 确保总线空闲 // HOW TO us_delay(4); // 额外的  SDA=1;SCL=1; // 是否需要延时？延时多少  // START 符号 SDA=0;SCL=1; // T_hd;sta &gt; 4.0 us us_delay(4); SDA=0;SCL=0; 发送 // T_low &gt; 4.7, T_high &gt; 4.0us SCL = 0; us_delay(5); // 数据 SDA = xx; // T_su;dat &gt; 250ns us_delay(1); // 拉高SCL SCL = 1; // T_high &gt; 4.0us us_delay(4); // 拉低SCL SCL = 0; // T_high &gt; 4."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://psuvtk.github.io/css/style-classic.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://psuvtk.github.io/images/favicon.ico" />

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/about">About Me</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://psuvtk.github.io/posts/10.-%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://psuvtk.github.io/posts/12.-lua/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&text=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&title=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&is_video=false&description=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=I2C%e6%80%bb%e7%ba%bf&body=Check out this article: https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&title=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&title=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&name=I2C%e6%80%bb%e7%ba%bf&description=%e6%97%b6%e9%92%9f%e5%bb%b6%e5%b1%95%20%e6%80%bb%e7%ba%bf%e6%8c%82%e6%ad%bb%20I2C%e5%ad%90%e7%b3%bb%e7%bb%9f%20Linux%e5%86%85%e6%a0%b8%e5%ae%9e%e7%8e%b0%20TODO%0a%e8%bd%af%e4%bb%b6%e6%a8%a1%e6%8b%9fI2C%20Master%28GPIO%e6%a8%a1%e6%8b%9f%29%20%e6%a3%80%e6%b5%8b%e6%80%bb%e7%ba%bf%e6%98%af%e5%90%a6%e7%a9%ba%e9%97%b2%20%e5%8f%91%e9%80%81START%20%2f%2f%20%e7%a1%ae%e4%bf%9d%e6%80%bb%e7%ba%bf%e7%a9%ba%e9%97%b2%20%2f%2f%20HOW%20TO%20us_delay%284%29%3b%20%2f%2f%20%e9%a2%9d%e5%a4%96%e7%9a%84%20%20SDA%3d1%3bSCL%3d1%3b%20%2f%2f%20%e6%98%af%e5%90%a6%e9%9c%80%e8%a6%81%e5%bb%b6%e6%97%b6%ef%bc%9f%e5%bb%b6%e6%97%b6%e5%a4%9a%e5%b0%91%20%20%2f%2f%20START%20%e7%ac%a6%e5%8f%b7%20SDA%3d0%3bSCL%3d1%3b%20%2f%2f%20T_hd%3bsta%20%26gt%3b%204.0%20us%20us_delay%284%29%3b%20SDA%3d0%3bSCL%3d0%3b%20%e5%8f%91%e9%80%81%20%2f%2f%20T_low%20%26gt%3b%204.7%2c%20T_high%20%26gt%3b%204.0us%20SCL%20%3d%200%3b%20us_delay%285%29%3b%20%2f%2f%20%e6%95%b0%e6%8d%ae%20SDA%20%3d%20xx%3b%20%2f%2f%20T_su%3bdat%20%26gt%3b%20250ns%20us_delay%281%29%3b%20%2f%2f%20%e6%8b%89%e9%ab%98SCL%20SCL%20%3d%201%3b%20%2f%2f%20T_high%20%26gt%3b%204.0us%20us_delay%284%29%3b%20%2f%2f%20%e6%8b%89%e4%bd%8eSCL%20SCL%20%3d%200%3b%20%2f%2f%20T_high%20%26gt%3b%204.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&t=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#heading"></a></li>
    <li><a href="#时钟延展">时钟延展</a></li>
    <li><a href="#总线挂死">总线挂死</a></li>
    <li><a href="#i2c子系统-linux内核实现">I2C子系统 Linux内核实现</a></li>
    <li><a href="#软件模拟i2c-mastergpio模拟">软件模拟I2C Master(GPIO模拟)</a>
      <ul>
        <li><a href="#检测总线是否空闲">检测总线是否空闲</a></li>
        <li><a href="#发送start">发送START</a></li>
      </ul>
    </li>
    <li><a href="#发送">发送</a></li>
    <li><a href="#停止">停止</a></li>
    <li><a href="#gpio-模式配置stgd">GPIO 模式配置(ST/GD)</a>
      <ul>
        <li><a href="#为什么不能直接使用芯片内部的上拉电阻">为什么不能直接使用芯片内部的上拉电阻</a></li>
      </ul>
    </li>
    <li><a href="#i2c-slave">I2C Slave</a>
      <ul>
        <li><a href="#ti-参考代码">TI 参考代码</a></li>
      </ul>
    </li>
    <li><a href="#linux-i2c-驱动">Linux I2C 驱动</a>
      <ul>
        <li><a href="#gpio-模拟">GPIO 模拟</a></li>
      </ul>
    </li>
    <li><a href="#学习文档">学习文档</a></li>
  </ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        I2C总线
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-10-19 20:18:47 &#43;0800 CST" itemprop="datePublished">2022-10-19</time>
          
        </div>
        
        
        
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <h2 id="heading"></h2>
<h2 id="时钟延展">时钟延展</h2>
<h2 id="总线挂死">总线挂死</h2>
<h2 id="i2c子系统-linux内核实现">I2C子系统 Linux内核实现</h2>
<p>TODO</p>
<h2 id="软件模拟i2c-mastergpio模拟">软件模拟I2C Master(GPIO模拟)</h2>
<h3 id="检测总线是否空闲">检测总线是否空闲</h3>
<h3 id="发送start">发送START</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// 确保总线空闲
</span><span style="color:#75715e">// HOW TO
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">4</span>); <span style="color:#75715e">// 额外的
</span><span style="color:#75715e"></span>
SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
<span style="color:#75715e">// 是否需要延时？延时多少
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// START 符号
</span><span style="color:#75715e"></span>SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
<span style="color:#75715e">// T_hd;sta &gt; 4.0 us
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">4</span>);

SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</code></pre></div><p><img src="../../images/i2c_start.png" alt="I2C_START.png"></p>
<h2 id="发送">发送</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// T_low &gt; 4.7, T_high &gt; 4.0us 
</span><span style="color:#75715e"></span>SCL <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
us_delay(<span style="color:#ae81ff">5</span>);

<span style="color:#75715e">// 数据
</span><span style="color:#75715e"></span>SDA <span style="color:#f92672">=</span> xx;
<span style="color:#75715e">// T_su;dat &gt; 250ns
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">1</span>);

<span style="color:#75715e">// 拉高SCL
</span><span style="color:#75715e"></span>SCL <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
<span style="color:#75715e">// T_high &gt; 4.0us
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">4</span>);

<span style="color:#75715e">// 拉低SCL
</span><span style="color:#75715e"></span>SCL <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#75715e">// T_high &gt; 4.0us
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">1</span>);
</code></pre></div><h2 id="停止">停止</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
us_delay(<span style="color:#ae81ff">5</span>);

SCL<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
<span style="color:#75715e">// T_su;sto &gt; 4.0us
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">4</span>);

SDA<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
<span style="color:#75715e">// T_hd;dat
</span><span style="color:#75715e"></span>us_delay(<span style="color:#ae81ff">5</span>);
</code></pre></div><p><img src="../../images/i2c_stop.png" alt="I2C_START.png"></p>
<h2 id="gpio-模式配置stgd">GPIO 模式配置(ST/GD)</h2>
<ul>
<li>
<p>输入</p>
<ul>
<li>浮空输入</li>
</ul>
</li>
<li>
<p>输出</p>
<ul>
<li>开漏输出模式</li>
<li>NOPULL 模式</li>
<li>FREQ HIGH模式</li>
</ul>
</li>
</ul>
<p>GD32、STM32在GPIO 输出配置章节有如下描述;</p>
<pre><code>开漏模式：输出控制寄存器设置为“0”时，相应引脚输出低电平；输出控制寄存器设置 为
“1”，相应管脚处于高阻状态；
</code></pre><h3 id="为什么不能直接使用芯片内部的上拉电阻">为什么不能直接使用芯片内部的上拉电阻</h3>
<p>内部实现的是弱上拉(40K Ohm), 不满足时序要求；
外部上拉电阻一般使用4.7K Ohm;</p>
<h2 id="i2c-slave">I2C Slave</h2>
<p><img src="../../images/i2c_slave_fsm.png" alt="i2c_slave_fsm.png"></p>
<h3 id="ti-参考代码">TI 参考代码</h3>
<ul>
<li>fr2111_swi2c_master.h</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* --COPYRIGHT--,BSD
</span><span style="color:#75715e"> * Copyright (c) 2016, Texas Instruments Incorporated
</span><span style="color:#75715e"> * All rights reserved.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Redistribution and use in source and binary forms, with or without
</span><span style="color:#75715e"> * modification, are permitted provided that the following conditions
</span><span style="color:#75715e"> * are met:
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Redistributions of source code must retain the above copyright
</span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Redistributions in binary form must reproduce the above copyright
</span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer in the
</span><span style="color:#75715e"> *    documentation and/or other materials provided with the distribution.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span><span style="color:#75715e"> *    its contributors may be used to endorse or promote products derived
</span><span style="color:#75715e"> *    from this software without specific prior written permission.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span><span style="color:#75715e"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span><span style="color:#75715e"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span><span style="color:#75715e"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span><span style="color:#75715e"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span><span style="color:#75715e"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span><span style="color:#75715e"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span><span style="color:#75715e"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span><span style="color:#75715e"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span><span style="color:#75715e"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span><span style="color:#75715e"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span><span style="color:#75715e"> * --/COPYRIGHT--*/</span>
<span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;msp430.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdbool.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdint.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* Pin Definitions. These  should be changed depending on the device that
</span><span style="color:#75715e"> * you are using.
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">#define SWI2C_SCL         BIT3
</span><span style="color:#75715e">#define SWI2C_SDA         BIT2
</span><span style="color:#75715e">#define SWI2C_PxDIR       P1DIR
</span><span style="color:#75715e">#define SWI2C_PxOUT       P1OUT
</span><span style="color:#75715e">#define SWI2C_PxIN        P1IN
</span><span style="color:#75715e">#define SWI2C_SDA_LOW     SWI2C_PxDIR |= SWI2C_SDA
</span><span style="color:#75715e">#define SWI2C_SCL_LOW     SWI2C_PxDIR |= SWI2C_SCL
</span><span style="color:#75715e">#define SWI2C_SCL_HIGH    SWI2C_PxDIR &amp;= ~SWI2C_SCL
</span><span style="color:#75715e">#define SWI2C_SDA_HIGH    SWI2C_PxDIR &amp;= ~SWI2C_SDA
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* Defines the buffer size to be used. This will change depending on your
</span><span style="color:#75715e"> * application and the size requirements for the transfer.
</span><span style="color:#75715e"> */</span>

<span style="color:#75715e">/* Configuration structure for performing an I2C transaction */</span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _SWI2C_I2CTransaction
{
    uint8_t             address;
    uint_fast16_t       numWriteBytes;
    uint8_t<span style="color:#f92672">*</span>            writeBuffer;
    uint_fast16_t       numReadBytes;
    uint8_t<span style="color:#f92672">*</span>            readBuffer;
    <span style="color:#66d9ef">bool</span>                repeatedStart;
} SWI2C_I2CTransaction;

<span style="color:#75715e">/* Timer period for determining the clock rate of the I2C data clock. Note that
</span><span style="color:#75715e"> * the timer is sourced from SMCLK and that this number is equal to the duration
</span><span style="color:#75715e"> * of roughly HALF a clock period. For example, if SMCLK is set to 3MHz and the
</span><span style="color:#75715e"> * period below is set to 15, we would end up with an I2C data rate of
</span><span style="color:#75715e"> * approximately 100Khz.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * In short, the I2C data rate frequency can be calculated by:
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * I2C Data Rate =      SMCLK Frequency
</span><span style="color:#75715e"> *                    ___________________
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> *                      2 * TimerPeriod
</span><span style="color:#75715e"> */</span>
<span style="color:#75715e">#define SWI2C_TIMER_PERIOD  15
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* Macro for a timer iteration */</span>
<span style="color:#75715e">#define TIMER_ITERATION()            TB0CCTL0 &amp;= ~(CCIFG);           \
</span><span style="color:#75715e">                                     while(!(TB0CCTL0 &amp; CCIFG));
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* Function Prototypes */</span>

<span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//! Initializes the software I2C master. This function takes the port
</span><span style="color:#75715e">//! definitions that are given above and configures the device for software
</span><span style="color:#75715e">//! I2C operation.
</span><span style="color:#75715e">//!
</span><span style="color:#75715e">//! \return None
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SWI2C_initI2C</span>(<span style="color:#66d9ef">void</span>);

<span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//! Starts an I2C transaction over the configured I2C master device. Note that
</span><span style="color:#75715e">//! this function is blocking until the transaction is completed. If a timeout
</span><span style="color:#75715e">//! feature is required, the user should use the watchdog module of their MCU
</span><span style="color:#75715e">//! in tandem with this function. Since the I2C slave has the ability to
</span><span style="color:#75715e">//! &#34;clock stretch&#34; the module, care has to be taken to manage the real time
</span><span style="color:#75715e">//!  behavior of the main application.
</span><span style="color:#75715e">//!
</span><span style="color:#75715e">//! &lt;hr&gt;
</span><span style="color:#75715e">//! &lt;b&gt;Configuration options for \link SWI2C_I2CTransaction \endlink structure.&lt;/b&gt;
</span><span style="color:#75715e">//! &lt;hr&gt;
</span><span style="color:#75715e">//!
</span><span style="color:#75715e">//! \param address I2C Slave Address to communicate with.
</span><span style="color:#75715e">//! \param numWriteBytes Number of bytes for the master to write
</span><span style="color:#75715e">//! \param writeBuffer Pointer to the buffer to write
</span><span style="color:#75715e">//! \param numReadBytes Number of bytes to read
</span><span style="color:#75715e">//! \param readBuffer Pointer to the buffer to read values into
</span><span style="color:#75715e">//! \param repeatedStart In the event that both a read and write operation are
</span><span style="color:#75715e">//!         requested, this bool value determines if a repeated start coniditon
</span><span style="color:#75715e">//!         is sent out over the bus. If set to true, no I2C STOP is sent out
</span><span style="color:#75715e">//!         after the write transaction. If set to false. After the write
</span><span style="color:#75715e">//!         transaction completes an I2C STOP condition is sent out, and then
</span><span style="color:#75715e">//!         the I2C read transaction is treated as a completely separate
</span><span style="color:#75715e">//!         transaction
</span><span style="color:#75715e">//!
</span><span style="color:#75715e">//! Note that any order of combinations can be passed into the transaction
</span><span style="color:#75715e">//! structure. If the user wants to only perform an I2C read, then only the
</span><span style="color:#75715e">//! read parameters should be populated and the write parameters should be
</span><span style="color:#75715e">//! set to 0 (or vice versa for write). The user can also specify both read
</span><span style="color:#75715e">//! and write bytes and use the repeatedStart parameter to specify if there
</span><span style="color:#75715e">//! is an I2C STOP between the transactions. Note that the write transaction
</span><span style="color:#75715e">//! is always first when using this function.
</span><span style="color:#75715e">//!
</span><span style="color:#75715e">//! \return true if the operation passed, false otherwise. A false return
</span><span style="color:#75715e">//!     value means that the device received a NAK where one was not expected.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e"></span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_performI2CTransaction</span>(SWI2C_I2CTransaction <span style="color:#f92672">*</span>i2cTransaction);
</code></pre></div><ul>
<li>fr2111_swi2c_master.c</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* --COPYRIGHT--,BSD
</span><span style="color:#75715e"> * Copyright (c) 2016, Texas Instruments Incorporated
</span><span style="color:#75715e"> * All rights reserved.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Redistribution and use in source and binary forms, with or without
</span><span style="color:#75715e"> * modification, are permitted provided that the following conditions
</span><span style="color:#75715e"> * are met:
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Redistributions of source code must retain the above copyright
</span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Redistributions in binary form must reproduce the above copyright
</span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer in the
</span><span style="color:#75715e"> *    documentation and/or other materials provided with the distribution.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span><span style="color:#75715e"> *    its contributors may be used to endorse or promote products derived
</span><span style="color:#75715e"> *    from this software without specific prior written permission.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span><span style="color:#75715e"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span><span style="color:#75715e"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span><span style="color:#75715e"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span><span style="color:#75715e"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span><span style="color:#75715e"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span><span style="color:#75715e"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span><span style="color:#75715e"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span><span style="color:#75715e"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span><span style="color:#75715e"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span><span style="color:#75715e"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span><span style="color:#75715e"> * --/COPYRIGHT--*/</span>
<span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;fr2111_swi2c_master.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/* Static Functions */</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_readData</span>(uint8_t addr,  uint8_t <span style="color:#f92672">*</span>inputArray,
                            uint_fast16_t size);
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_writeData</span>(uint8_t addr, uint8_t <span style="color:#f92672">*</span>outputArray, 
                                uint_fast16_t size, <span style="color:#66d9ef">bool</span> sendStop);

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">SWI2C_initI2C</span>(<span style="color:#66d9ef">void</span>)
{
    <span style="color:#75715e">/* Using the direction pin to control the output. When set as an input, the
</span><span style="color:#75715e">        hardware pull-ups will take over and cause the pin to go high. When
</span><span style="color:#75715e">        set as an output, the MSP430 will drive the lines low */</span>
    SWI2C_PxOUT <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(SWI2C_SCL <span style="color:#f92672">|</span> SWI2C_SDA);
    SWI2C_SCL_HIGH;
    SWI2C_SDA_HIGH;

    PM5CTL0 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>LOCKLPM5;                   <span style="color:#75715e">// Disable the GPIO power-on default high-impedance mode
</span><span style="color:#75715e"></span>                                            <span style="color:#75715e">// to activate previously configured port settings
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">/* Timer is initialized to run off SMCLK(8MHz) with frequency 200KHz */</span>
    TB0CCR0 <span style="color:#f92672">=</span> SWI2C_TIMER_PERIOD;
}

<span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_performI2CTransaction</span>(SWI2C_I2CTransaction <span style="color:#f92672">*</span>i2cTransaction)
{
    <span style="color:#66d9ef">if</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>numWriteBytes <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
    {
        <span style="color:#75715e">/* Only skipping the stop if we have a repeated start to send */</span>
        <span style="color:#66d9ef">if</span>(i2cTransaction<span style="color:#f92672">-&gt;</span>repeatedStart <span style="color:#f92672">&amp;&amp;</span> i2cTransaction<span style="color:#f92672">-&gt;</span>numReadBytes <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
        {
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>SWI2C_writeData(i2cTransaction<span style="color:#f92672">-&gt;</span>address,
                    i2cTransaction<span style="color:#f92672">-&gt;</span>writeBuffer, i2cTransaction<span style="color:#f92672">-&gt;</span>numWriteBytes,
                    false))
            {
                <span style="color:#66d9ef">return</span> false;
            }
        }
        <span style="color:#66d9ef">else</span>
        {
            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>SWI2C_writeData(i2cTransaction<span style="color:#f92672">-&gt;</span>address,
                    i2cTransaction<span style="color:#f92672">-&gt;</span>writeBuffer, i2cTransaction<span style="color:#f92672">-&gt;</span>numWriteBytes,
                    true))
            {
                <span style="color:#66d9ef">return</span> false;
            }
        }
    }

    <span style="color:#75715e">/* Next doing the read */</span>
    <span style="color:#66d9ef">if</span> (i2cTransaction<span style="color:#f92672">-&gt;</span>numReadBytes <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
    {
        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>SWI2C_readData(i2cTransaction<span style="color:#f92672">-&gt;</span>address, i2cTransaction<span style="color:#f92672">-&gt;</span>readBuffer,
                i2cTransaction<span style="color:#f92672">-&gt;</span>numReadBytes))
        {
            <span style="color:#66d9ef">return</span> false;
        }
    }
    
    <span style="color:#66d9ef">return</span> true;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_writeData</span>(uint8_t addr, uint8_t <span style="color:#f92672">*</span>outputArray, 
                                uint_fast16_t size, <span style="color:#66d9ef">bool</span> sendStop)
{
    uint_fast8_t bits, temp;
    uint16_t ii <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">/* Starting the timer */</span>
    TB0CTL <span style="color:#f92672">=</span> TBSSEL_2 <span style="color:#f92672">+</span> MC_1 <span style="color:#f92672">+</span> TBCLR;

    <span style="color:#75715e">/* Sending the START */</span>
    SWI2C_SDA_LOW;
    __no_operation();
    SWI2C_SCL_LOW;
    TIMER_ITERATION();
    
    <span style="color:#75715e">/* Next doing the control byte */</span>
    temp <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
    bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
    
    <span style="color:#75715e">/* Loop until all bits of the address byte are sent out */</span>
    <span style="color:#66d9ef">do</span>
    {
        <span style="color:#75715e">/* Deciding if we want to send a high or low out of the line */</span>
        <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">&amp;</span> BIT7) 
        {                  
            SWI2C_SDA_HIGH;
        }
        <span style="color:#66d9ef">else</span>
        {
            SWI2C_SDA_LOW;
        }                 

        <span style="color:#75715e">/* Now that we set the SDA line, we have to send out a clock pulse */</span>
        SWI2C_SCL_HIGH;
        TIMER_ITERATION();

        <span style="color:#75715e">/* Incrementing to the next bit and waiting for the next clock cycle */</span>
        temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
        bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
        
        SWI2C_SCL_LOW;
        TIMER_ITERATION();


    } <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
    
    <span style="color:#75715e">/* Detecting if we have a NAK on the bus. If the slave device NAKed the 
</span><span style="color:#75715e">        control byte, it probably isn&#39;t there on the bus so we should send
</span><span style="color:#75715e">         an I2C stop and return false */</span>
    SWI2C_SDA_HIGH;
    SWI2C_SCL_HIGH;
    <span style="color:#75715e">/*
</span><span style="color:#75715e">    * Waiting for our clock line to go high if the slave is stretching
</span><span style="color:#75715e">    */</span>
    <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));

    TIMER_ITERATION();

    <span style="color:#66d9ef">if</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA)
    {
        <span style="color:#66d9ef">goto</span> I2CWriteTransactionCleanUp;
    }
    
    <span style="color:#75715e">/* Sending out another clock cycle */</span>
    SWI2C_SCL_LOW;
    TIMER_ITERATION();
    
    <span style="color:#75715e">/* Next, let us send out all bytes in the user buffer */</span>
    <span style="color:#66d9ef">for</span>(ii<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;ii<span style="color:#f92672">&lt;</span>size;ii<span style="color:#f92672">++</span>)
    {
        temp <span style="color:#f92672">=</span> outputArray[ii];
        bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
        
        <span style="color:#75715e">/* Loop until all bits of the current byte are sent out */</span>
        <span style="color:#66d9ef">do</span>
        {
            <span style="color:#75715e">/* Deciding if we want to send a high or low out of the line */</span>
            <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">&amp;</span> BIT7) 
            {                  
                SWI2C_SDA_HIGH;
            }
            <span style="color:#66d9ef">else</span>
            {
                SWI2C_SDA_LOW;
            }                 

            <span style="color:#75715e">/* Now that we set the SDA line, we send out a clock pulse */</span>
            SWI2C_SCL_HIGH;
            TIMER_ITERATION();

            <span style="color:#75715e">/* Incrementing to the next bit and waiting for next clock cycle */</span>
            temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
            bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
            SWI2C_SCL_LOW;
            TIMER_ITERATION();
            
        } <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
        
        <span style="color:#75715e">/* Detecting the NAK. We should break out of the send loop */</span>
        SWI2C_SDA_HIGH;
        SWI2C_SCL_HIGH;
       <span style="color:#75715e">/*
</span><span style="color:#75715e">        * Waiting for our clock line to go high if the slave is stretching
</span><span style="color:#75715e">        */</span>
        <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));

        TIMER_ITERATION();

        <span style="color:#66d9ef">if</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA)
        {
            <span style="color:#66d9ef">goto</span> I2CWriteTransactionCleanUp;
        }
        
        <span style="color:#75715e">/* Sending out another clock cycle */</span>
        SWI2C_SCL_LOW;
        TIMER_ITERATION();
    }

I2CWriteTransactionCleanUp:    
    <span style="color:#75715e">/* If the user did not request to skip, we send out the stop bit */</span>
    <span style="color:#66d9ef">if</span>((sendStop <span style="color:#f92672">&amp;&amp;</span> ii <span style="color:#f92672">==</span> size) <span style="color:#f92672">||</span> (ii <span style="color:#f92672">!=</span> size))
    {
        SWI2C_SCL_LOW;
        TIMER_ITERATION();
        SWI2C_SDA_LOW;
        TIMER_ITERATION();
        SWI2C_SCL_HIGH;
        __no_operation();
        SWI2C_SDA_HIGH;
    }
    <span style="color:#66d9ef">else</span>
    {
        SWI2C_SCL_HIGH;
        SWI2C_SDA_HIGH;
    }
    
    <span style="color:#75715e">/* Stop the timer */</span>
    TB0CTL <span style="color:#f92672">=</span> MC_0;
    
    <span style="color:#75715e">/* If all bytes were sent, return true- otherwise false. */</span>
    <span style="color:#66d9ef">if</span>(ii <span style="color:#f92672">==</span> size)
        <span style="color:#66d9ef">return</span> true;
    <span style="color:#66d9ef">else</span>
        <span style="color:#66d9ef">return</span> false;
}

<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">SWI2C_readData</span>(uint8_t addr, uint8_t <span style="color:#f92672">*</span>inputArray, 
                            uint_fast16_t size)
{
    uint_fast8_t bits, temp;
    uint16_t ii <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">/* Starting the timer */</span>
    TB0CTL <span style="color:#f92672">=</span> TBSSEL_2 <span style="color:#f92672">+</span> MC_1 <span style="color:#f92672">+</span> TBCLR;

    <span style="color:#75715e">/* Sending the START */</span>
    SWI2C_SDA_LOW;
    __no_operation();
    SWI2C_SCL_LOW;
    TIMER_ITERATION();

    <span style="color:#75715e">/* Next doing the control byte */</span>
    temp <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">|</span> BIT0;
    bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
    
    <span style="color:#75715e">/* Loop until all bits of the address byte are sent out */</span>
    <span style="color:#66d9ef">do</span>
    {
        <span style="color:#75715e">/* Deciding if we want to send a high or low out of the line */</span>
        <span style="color:#66d9ef">if</span> (temp <span style="color:#f92672">&amp;</span> BIT7) 
        {                  
            SWI2C_SDA_HIGH;
        }
        <span style="color:#66d9ef">else</span>
        {
            SWI2C_SDA_LOW;
        }                 

        <span style="color:#75715e">/* Now that we set the SDA line, we have to send out a clock pulse */</span>
        SWI2C_SCL_HIGH;
        TIMER_ITERATION();

        <span style="color:#75715e">/* Incrementing to the next bit and waiting for the next clock cycle */</span>
        temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
        bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
        SWI2C_SCL_LOW;
        TIMER_ITERATION();
        
    } <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
    
    <span style="color:#75715e">/* Detecting if we have a NAK on the bus. If the slave device NAKed the 
</span><span style="color:#75715e">        control byte, it probably isn&#39;t there on the bus so we should send
</span><span style="color:#75715e">         an I2C stop and return false */</span>
    SWI2C_SDA_HIGH;
    SWI2C_SCL_HIGH;
    TIMER_ITERATION();

    <span style="color:#66d9ef">if</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA)
    {
        <span style="color:#66d9ef">goto</span> I2CReadTransactionCleanUp;
    }
    
    <span style="color:#75715e">/* Next, we want to read out all of the data requested */</span>
    <span style="color:#66d9ef">for</span>(ii<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;ii<span style="color:#f92672">&lt;</span>size;ii<span style="color:#f92672">++</span>)
    {
        <span style="color:#75715e">/*
</span><span style="color:#75715e">        * Waiting for our clock line to go high if the slave is stretching
</span><span style="color:#75715e">        */</span>
        <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));

        <span style="color:#75715e">/* Setup the read variables */</span>
        temp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        bits <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x08</span>;

         <span style="color:#75715e">/* Sending out another clock cycle */</span>
         SWI2C_SCL_LOW;
         TIMER_ITERATION();
         SWI2C_SDA_HIGH;

        <span style="color:#75715e">/* Loop to read until all bits have been read */</span>
        <span style="color:#66d9ef">do</span>
        {
            <span style="color:#75715e">/* Priming our temporary variable and sending a clock pulse */</span>
            temp <span style="color:#f92672">=</span> (temp <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">1</span>);
            SWI2C_SCL_HIGH;
            TIMER_ITERATION();
            
            <span style="color:#75715e">/* If the data line is high, recording that */</span>
            <span style="color:#66d9ef">if</span> (SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SDA) 
            {
              temp <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>;
            }
            
            <span style="color:#75715e">/* Send out another clock cycle and decrement our counter */</span>
            bits <span style="color:#f92672">=</span> (bits <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
            SWI2C_SCL_LOW;
            TIMER_ITERATION();
        }
        <span style="color:#66d9ef">while</span> (bits <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);

        <span style="color:#75715e">/* Storing the data off */</span>
        inputArray[ii] <span style="color:#f92672">=</span> temp;

        <span style="color:#75715e">/* Now the master needs to send out the ACK */</span>
        <span style="color:#66d9ef">if</span>(ii <span style="color:#f92672">==</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
            SWI2C_SDA_HIGH;
        <span style="color:#66d9ef">else</span>
        	SWI2C_SDA_LOW;
        SWI2C_SCL_HIGH;

        <span style="color:#75715e">/*
</span><span style="color:#75715e">        * Waiting for our clock line to go high if the slave is stretching
</span><span style="color:#75715e">        */</span>
        <span style="color:#66d9ef">while</span>(<span style="color:#f92672">!</span>(SWI2C_PxIN <span style="color:#f92672">&amp;</span> SWI2C_SCL));

        TIMER_ITERATION();
    }

I2CReadTransactionCleanUp:

    <span style="color:#75715e">/* Sending out the stop bit */</span>
    SWI2C_SCL_LOW;
    SWI2C_SDA_LOW;
    TIMER_ITERATION();
    SWI2C_SCL_HIGH;
    __no_operation();
    SWI2C_SDA_HIGH;
    TIMER_ITERATION();

    <span style="color:#75715e">/* Stop the timer */</span>
    TB0CTL <span style="color:#f92672">=</span> MC_0;

    <span style="color:#75715e">/* If all bytes were read, return true- otherwise false. */</span>
    <span style="color:#66d9ef">if</span>(ii <span style="color:#f92672">==</span> size)
        <span style="color:#66d9ef">return</span> true;
    <span style="color:#66d9ef">else</span>
        <span style="color:#66d9ef">return</span> false;
}

</code></pre></div><ul>
<li>FR2111_SW_I2C_Slave.c</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/* --COPYRIGHT--,BSD
</span><span style="color:#75715e"> * Copyright (c) 2016, Texas Instruments Incorporated
</span><span style="color:#75715e"> * All rights reserved.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * Redistribution and use in source and binary forms, with or without
</span><span style="color:#75715e"> * modification, are permitted provided that the following conditions
</span><span style="color:#75715e"> * are met:
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Redistributions of source code must retain the above copyright
</span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Redistributions in binary form must reproduce the above copyright
</span><span style="color:#75715e"> *    notice, this list of conditions and the following disclaimer in the
</span><span style="color:#75715e"> *    documentation and/or other materials provided with the distribution.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span><span style="color:#75715e"> *    its contributors may be used to endorse or promote products derived
</span><span style="color:#75715e"> *    from this software without specific prior written permission.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span><span style="color:#75715e"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span><span style="color:#75715e"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span><span style="color:#75715e"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span><span style="color:#75715e"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span><span style="color:#75715e"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span><span style="color:#75715e"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span><span style="color:#75715e"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span><span style="color:#75715e"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span><span style="color:#75715e"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span><span style="color:#75715e"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span><span style="color:#75715e"> * --/COPYRIGHT--*/</span>
<span style="color:#75715e">//*****************************************************************************
</span><span style="color:#75715e">//  MSP430FR2111 Software I2C Slave
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//  Description: This demo connects two MSP430&#39;s via the I2C bus. The master is
</span><span style="color:#75715e">//  MSP430FR2311 with hardware I2C(eUSCI_B0). The slave is MSP430FR2111 using GPIOs
</span><span style="color:#75715e">//  to implement software I2C. The master write to and read from the slave.
</span><span style="color:#75715e">//  This is the slave code.
</span><span style="color:#75715e">//  MCLK = SMCLK = 8MHz.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//    *****used with &#34;FR2311_HW_I2C_Master.c&#34;****
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//                                /|\  /|\
</span><span style="color:#75715e">//               MSP430FR2311      10k  10k     MSP430FR2111
</span><span style="color:#75715e">//                   master         |    |        slave
</span><span style="color:#75715e">//             -----------------   |    |   -----------------
</span><span style="color:#75715e">//            |     P1.2/UCB0SDA|&lt;-|----|-&gt;|P2.0(SW I2C)     |
</span><span style="color:#75715e">//            |                 |  |       |                 |
</span><span style="color:#75715e">//            |                 |  |       |                 |
</span><span style="color:#75715e">//            |     P1.3/UCB0SCL|&lt;-|------&gt;|P1.0(SW I2C)     |
</span><span style="color:#75715e">//            |                 |          |                 |
</span><span style="color:#75715e">//
</span><span style="color:#75715e">//   Texas Instruments Inc.
</span><span style="color:#75715e">//   June. 2016
</span><span style="color:#75715e">//******************************************************************************
</span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;msp430.h&gt; </span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define SCL BIT0
</span><span style="color:#75715e">#define SDA BIT0
</span><span style="color:#75715e">#define I2COA 0x0A               </span><span style="color:#75715e">// Slave address
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define I2C_START     1          </span><span style="color:#75715e">// Start condition
</span><span style="color:#75715e"></span><span style="color:#75715e">#define I2C_STOP      2          </span><span style="color:#75715e">// Stop condition
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W1LH      3          </span><span style="color:#75715e">// Bit 1 (first clk rising edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W1HL      4          </span><span style="color:#75715e">// Bit 1 (first clk falling edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W2to6LH   5          </span><span style="color:#75715e">// Bit 2-6(2nd~6th  clk rising edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W7LH      6          </span><span style="color:#75715e">// Bit 7 (7th  clk rising edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W8LH      7          </span><span style="color:#75715e">// Bit 8 (8th  clk rising edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W8HL      8          </span><span style="color:#75715e">// Set ACK (8th  clk falling edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_W9HL      9          </span><span style="color:#75715e">// Re-init R4 (9th  clk falling edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R1HL      10         </span><span style="color:#75715e">// Bit 1 (first clk falling edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R1LH      11         </span><span style="color:#75715e">// Bit 1 (first clk rising edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R2to8HL   12         </span><span style="color:#75715e">// Bit 2-8 (2nd~8th clk falling edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R9HL      13         </span><span style="color:#75715e">// Free SDA (9th clk falling edge)
</span><span style="color:#75715e"></span><span style="color:#75715e">#define SCL_R9LH      14         </span><span style="color:#75715e">// Check ACK (9th clk rising edge)
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#define MCLK_FREQ_MHZ 8          </span><span style="color:#75715e">// MCLK = 8MHz
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> ram_data[<span style="color:#ae81ff">16</span>];
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> I2C_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> cnt_2to6<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> cnt_2to8<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> RW_flag<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> ram_cnt<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitBuffer</span>();
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">INIT_PORT</span>();
<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Software_Trim</span>();

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>) {
	WDTCTL <span style="color:#f92672">=</span> WDTPW <span style="color:#f92672">|</span> WDTHOLD;	            <span style="color:#75715e">// Stop watchdog timer
</span><span style="color:#75715e"></span>
    __bis_SR_register(SCG0);                <span style="color:#75715e">// Disable FLL
</span><span style="color:#75715e"></span>    CSCTL3 <span style="color:#f92672">=</span> SELREF__REFOCLK;               <span style="color:#75715e">// Set REFO as FLL reference source
</span><span style="color:#75715e"></span>    CSCTL1 <span style="color:#f92672">=</span> DCOFTRIMEN_1 <span style="color:#f92672">|</span> DCOFTRIM0 <span style="color:#f92672">|</span> DCOFTRIM1 <span style="color:#f92672">|</span> DCORSEL_3;<span style="color:#75715e">// DCOFTRIM=3, DCO Range = 8MHz
</span><span style="color:#75715e"></span>    CSCTL2 <span style="color:#f92672">=</span> FLLD_0 <span style="color:#f92672">+</span> <span style="color:#ae81ff">243</span>;                  <span style="color:#75715e">// DCODIV = 8MHz
</span><span style="color:#75715e"></span>    __delay_cycles(<span style="color:#ae81ff">3</span>);
    __bic_SR_register(SCG0);                <span style="color:#75715e">// Enable FLL
</span><span style="color:#75715e"></span>    Software_Trim();                        <span style="color:#75715e">// Software Trim to get the best DCOFTRIM value
</span><span style="color:#75715e"></span>    CSCTL4 <span style="color:#f92672">=</span> SELMS__DCOCLKDIV <span style="color:#f92672">|</span> SELA__REFOCLK; <span style="color:#75715e">// set default REFO(~32768Hz) as ACLK source, ACLK = 32768Hz
</span><span style="color:#75715e"></span>                                               <span style="color:#75715e">// default DCODIV as MCLK and SMCLK source
</span><span style="color:#75715e"></span>	InitBuffer();
	INIT_PORT();

	__enable_interrupt();
	<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>);
}

<span style="color:#66d9ef">void</span> <span style="color:#a6e22e">InitBuffer</span>()
{
	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> i;
	<span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">16</span>;i<span style="color:#f92672">++</span>)
	{
		ram_data[i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
	}
}

<span style="color:#75715e">// Set SCL and SDA to inputs
</span><span style="color:#75715e">// SDA interrupts on high-to-low transition
</span><span style="color:#75715e">// SCL interrupts on low-to-high transition
</span><span style="color:#75715e">// initially, just SDA interrupt is set
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">INIT_PORT</span>()
{
	P2OUT <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;    <span style="color:#75715e">// When the pins are set to
</span><span style="color:#75715e"></span>	P1OUT <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// output, low level should be seen
</span><span style="color:#75715e"></span>	P1DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// SCL and SDA defined as inputs
</span><span style="color:#75715e"></span>	P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;
	P2IES <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">//INT. on high-to-low transition
</span><span style="color:#75715e"></span>	P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// INT. on low-to-high transition
</span><span style="color:#75715e"></span>	P1IE  <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Disable SCL interrupt
</span><span style="color:#75715e"></span>	P2IE  <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">// Enable SDA interrupt
</span><span style="color:#75715e"></span>	P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Reset interrupt flag
</span><span style="color:#75715e"></span>	P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;

	PM5CTL0 <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>LOCKLPM5;  <span style="color:#75715e">// Disable the GPIO power-on default high-impedance mode
</span><span style="color:#75715e"></span>	                       <span style="color:#75715e">// to activate previously configured port settings
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// SDA(Port 2) interrupt service routine
</span><span style="color:#75715e">// Port 2 ISR, check Start or Stop condition from P2.0 and P1.0
</span><span style="color:#75715e">// Or it can check I/O interrupt from other P2 pins with interrupt function
</span><span style="color:#75715e"></span><span style="color:#75715e">#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
</span><span style="color:#75715e">#pragma vector=PORT2_VECTOR
</span><span style="color:#75715e"></span>__interrupt <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Port_2</span>(<span style="color:#66d9ef">void</span>)
<span style="color:#75715e">#elif defined(__GNUC__)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __attribute__ ((interrupt(PORT2_VECTOR))) Port_2 (<span style="color:#66d9ef">void</span>)
<span style="color:#75715e">#else
</span><span style="color:#75715e">#error Compiler not supported!
</span><span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>{
	<span style="color:#66d9ef">if</span>((P1IN <span style="color:#f92672">&amp;</span> SCL <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span> (P2IFG <span style="color:#f92672">&amp;</span> SDA <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&amp;&amp;</span> (P2IES <span style="color:#f92672">&amp;</span> SDA <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>))
	{
		I2C_state <span style="color:#f92672">=</span> I2C_START; <span style="color:#75715e">// I2C start condition
</span><span style="color:#75715e"></span>	}
	<span style="color:#66d9ef">else</span>
	{
		I2C_state <span style="color:#f92672">=</span> I2C_STOP;
	}
	P2IFG <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;          <span style="color:#75715e">// Clear INT flag
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">switch</span>(I2C_state)
	{
	<span style="color:#66d9ef">case</span> I2C_START:
		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;  <span style="color:#75715e">// P1.0 clear INT flag
</span><span style="color:#75715e"></span>		P1IE <span style="color:#f92672">|=</span> SCL;    <span style="color:#75715e">// P1.0 INT enable for SCL
</span><span style="color:#75715e"></span>		P2IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;  <span style="color:#75715e">// P2.0 set to rising edge for SDA
</span><span style="color:#75715e"></span>		P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;  <span style="color:#75715e">// P2.0 clear INT flag
</span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SDA;  <span style="color:#75715e">// P2.0 INT disable for SDA
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W1LH;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> I2C_STOP:
		INIT_PORT();
		i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;   <span style="color:#75715e">// Reset I2CDATA for addr detect
</span><span style="color:#75715e"></span>		RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset RW_flag for addr detect
</span><span style="color:#75715e"></span>		ram_cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset buffer pointer
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
		<span style="color:#66d9ef">break</span>;
	}
}

<span style="color:#75715e">// SCL(Port 1) interrupt service routine
</span><span style="color:#75715e"></span><span style="color:#75715e">#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
</span><span style="color:#75715e">#pragma vector=PORT1_VECTOR
</span><span style="color:#75715e"></span>__interrupt <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Port_1</span>(<span style="color:#66d9ef">void</span>)
<span style="color:#75715e">#elif defined(__GNUC__)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __attribute__ ((interrupt(PORT1_VECTOR))) Port_1 (<span style="color:#66d9ef">void</span>)
<span style="color:#75715e">#else
</span><span style="color:#75715e">#error Compiler not supported!
</span><span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>{
	<span style="color:#66d9ef">switch</span>(I2C_state)
	{
	<span style="color:#66d9ef">case</span> SCL_W1LH:
		P1IES <span style="color:#f92672">|=</span> SCL;      <span style="color:#75715e">// Set falling edge for SCL
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)     <span style="color:#75715e">// Check SDA and update i2c_data
</span><span style="color:#75715e"></span>			i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// Shift SDA bit into the buffer
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span>
			i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset SCL interrupt flag
</span><span style="color:#75715e"></span>		P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;     <span style="color:#75715e">// Clear flag, FOR STP_CON DETECT
</span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">|=</span> SDA;       <span style="color:#75715e">// Enable SDA INT
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W1HL;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_W1HL:
		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SCL;    <span style="color:#75715e">// Set rising edge for SCL
</span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset SCL interrupt flag
</span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;      <span style="color:#75715e">// 1st FALLING SCL TO disable SDA INT
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W2to6LH;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_W2to6LH:
		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset interrupt flag
</span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)     <span style="color:#75715e">// Check SDA and and update i2c_data
</span><span style="color:#75715e"></span>			i2c_data<span style="color:#f92672">++</span>;
		<span style="color:#66d9ef">if</span>(cnt_2to6 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>)   <span style="color:#75715e">// 5bits(bit2 to bit6)
</span><span style="color:#75715e"></span>			cnt_2to6<span style="color:#f92672">++</span>;
		<span style="color:#66d9ef">else</span>
		{
			cnt_2to6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;  <span style="color:#75715e">// Reset counter
</span><span style="color:#75715e"></span>			I2C_state <span style="color:#f92672">=</span> SCL_W7LH;
		}
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_W7LH:
		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;     <span style="color:#75715e">// Reset interrupt flag
</span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)     <span style="color:#75715e">// Check SDA and and update i2c_data
</span><span style="color:#75715e"></span>		{
			i2c_data<span style="color:#f92672">++</span>;
		}
		<span style="color:#66d9ef">if</span>((RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">&amp;&amp;</span> (i2c_data <span style="color:#f92672">!=</span> I2COA) )
			I2C_state <span style="color:#f92672">=</span> I2C_STOP;
		<span style="color:#66d9ef">else</span>
			I2C_state <span style="color:#f92672">=</span> SCL_W8LH;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_W8LH:
		P1IES <span style="color:#f92672">|=</span> SCL;        <span style="color:#75715e">// Set falling edge for SCL.
</span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;       <span style="color:#75715e">// Reset interrupt flag
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
		{
			<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)   <span style="color:#75715e">// Check SDA and and update i2c_data
</span><span style="color:#75715e"></span>				RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// Read CMD
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">else</span>
				RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; <span style="color:#75715e">// Write CMD
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">else</span>
		{
			i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
			<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)   <span style="color:#75715e">// Check SDA and and update i2c_data
</span><span style="color:#75715e"></span>				i2c_data<span style="color:#f92672">++</span>;
		}
		I2C_state <span style="color:#f92672">=</span> SCL_W8HL;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_W8HL:
		P2DIR <span style="color:#f92672">|=</span> SDA;        <span style="color:#75715e">// Output &#34;0&#34; for SDA
</span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;       <span style="color:#75715e">//Reset SCL interrupt flag
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>)
		{
			i2c_data <span style="color:#f92672">=</span> ram_data[ram_cnt];
			ram_cnt<span style="color:#f92672">++</span>;
            ram_cnt <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x0f</span>;
			I2C_state <span style="color:#f92672">=</span> SCL_R1HL;<span style="color:#75715e">// Go to read state
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>)
		{
			RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
			I2C_state <span style="color:#f92672">=</span> SCL_W9HL;<span style="color:#75715e">// Go to write state
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(RW_flag <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>)
		{
			ram_data[ram_cnt] <span style="color:#f92672">=</span> i2c_data;
			ram_cnt<span style="color:#f92672">++</span>;
            ram_cnt <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x0f</span>;
			I2C_state <span style="color:#f92672">=</span> SCL_W9HL;<span style="color:#75715e">// Go to write state
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">else</span>
			I2C_state <span style="color:#f92672">=</span> I2C_STOP;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_W9HL:
		P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;        <span style="color:#75715e">// Release SDA
</span><span style="color:#75715e"></span>		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Set rising edge for SCL
</span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Reset interrupt flag
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_W1LH;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_R1HL:
		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Set rising edge SCL for SCL_R1LH
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(i2c_data <span style="color:#f92672">&amp;</span> BIT7)
			P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;    <span style="color:#75715e">// SDA = 1
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span>
			P2DIR <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">// SDA = 0
</span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SCL;       <span style="color:#75715e">// Clear SCL INT flag
</span><span style="color:#75715e"></span>		P2IE  <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SDA;       <span style="color:#75715e">// Disable SDA INT, NO STP CON
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_R1LH;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_R1LH:
		P1IES <span style="color:#f92672">|=</span> SCL;         <span style="color:#75715e">// Set falling edge for SCL
</span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Clear SCL INT flag
</span><span style="color:#75715e"></span>		P2IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;        <span style="color:#75715e">// Clear SDA INT Flag
</span><span style="color:#75715e"></span>		P2IE <span style="color:#f92672">|=</span> SDA;          <span style="color:#75715e">// Enable SDA INT for STOP CON
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_R2to8HL;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_R2to8HL:
		<span style="color:#66d9ef">if</span>(i2c_data <span style="color:#f92672">&amp;</span> BIT7)
			P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;    <span style="color:#75715e">// SDA = 1
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">else</span>
			P2DIR <span style="color:#f92672">|=</span> SDA;     <span style="color:#75715e">// SDA = 0
</span><span style="color:#75715e"></span>		i2c_data <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SCL;       <span style="color:#75715e">// Clear SCL INT flag
</span><span style="color:#75715e"></span>		P2IE  <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span> SDA;       <span style="color:#75715e">// Disable SDA INT, NO STP CON
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span>(cnt_2to8 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>)
		{
			cnt_2to8<span style="color:#f92672">++</span>;       <span style="color:#75715e">// 7bits(bit2 to bit8)
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">else</span>
		{
			cnt_2to8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;     <span style="color:#75715e">// Clear counter
</span><span style="color:#75715e"></span>			I2C_state <span style="color:#f92672">=</span> SCL_R9HL;
		}
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_R9HL:
		P2DIR <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SDA;        <span style="color:#75715e">// Release SDA
</span><span style="color:#75715e"></span>		P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Set Rising edge of SCL
</span><span style="color:#75715e"></span>		P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;        <span style="color:#75715e">// Clear SCL INT flag
</span><span style="color:#75715e"></span>		I2C_state <span style="color:#f92672">=</span> SCL_R9LH;
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> SCL_R9LH:
		<span style="color:#66d9ef">if</span>(P2IN <span style="color:#f92672">&amp;</span> SDA)        <span style="color:#75715e">// NACK_READ
</span><span style="color:#75715e"></span>		{
			P1IES <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Set rising edge of SCL
</span><span style="color:#75715e"></span>			P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Clear SCL INT flag
</span><span style="color:#75715e"></span>			I2C_state <span style="color:#f92672">=</span> SCL_W1LH; <span style="color:#75715e">// Go to SCL_W1LH to detect stop condition
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">else</span>                  <span style="color:#75715e">// ACK_READ
</span><span style="color:#75715e"></span>		{
			P1IES <span style="color:#f92672">|=</span> SCL;     <span style="color:#75715e">// Set falling edge of SCL
</span><span style="color:#75715e"></span>			P1IFG <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>SCL;    <span style="color:#75715e">// Clear SCL INT flag
</span><span style="color:#75715e"></span>			i2c_data <span style="color:#f92672">=</span> ram_data[ram_cnt]; <span style="color:#75715e">// Move out next byte from RAM buffer
</span><span style="color:#75715e"></span>			ram_cnt<span style="color:#f92672">++</span>;
			ram_cnt <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0x0f</span>;
			I2C_state <span style="color:#f92672">=</span> SCL_R1HL;<span style="color:#75715e">// Go to read state
</span><span style="color:#75715e"></span>		}
		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">case</span> I2C_STOP:
		INIT_PORT();
		i2c_data <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;   <span style="color:#75715e">// Reset I2CDATA for addr detect
</span><span style="color:#75715e"></span>		RW_flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset RW_flag for addr detect
</span><span style="color:#75715e"></span>		ram_cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">// Reset buffer pointer
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">break</span>;
	<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
		<span style="color:#66d9ef">break</span>;
	}
}

</code></pre></div><h2 id="linux-i2c-驱动">Linux I2C 驱动</h2>
<h3 id="gpio-模拟">GPIO 模拟</h3>
<p>算法: linux-6.1-rc2\drivers\i2c\algos\i2c-algo-bit.c
总线: linux-6.1-rc2\drivers\i2c\busses\i2c-gpio.c</p>
<h2 id="学习文档">学习文档</h2>
<ol>
<li>UM10204(I2C-bus specification and user manual) Texas Instruments</li>
<li>SPRABJ6(Software Implementation of PMBus Over I2C for TMS320F2803x)</li>
<li>从机状态机: SLAA703A(Software I2C on MSP430™ MCUs)</li>
</ol>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/about">About Me</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#heading"></a></li>
    <li><a href="#时钟延展">时钟延展</a></li>
    <li><a href="#总线挂死">总线挂死</a></li>
    <li><a href="#i2c子系统-linux内核实现">I2C子系统 Linux内核实现</a></li>
    <li><a href="#软件模拟i2c-mastergpio模拟">软件模拟I2C Master(GPIO模拟)</a>
      <ul>
        <li><a href="#检测总线是否空闲">检测总线是否空闲</a></li>
        <li><a href="#发送start">发送START</a></li>
      </ul>
    </li>
    <li><a href="#发送">发送</a></li>
    <li><a href="#停止">停止</a></li>
    <li><a href="#gpio-模式配置stgd">GPIO 模式配置(ST/GD)</a>
      <ul>
        <li><a href="#为什么不能直接使用芯片内部的上拉电阻">为什么不能直接使用芯片内部的上拉电阻</a></li>
      </ul>
    </li>
    <li><a href="#i2c-slave">I2C Slave</a>
      <ul>
        <li><a href="#ti-参考代码">TI 参考代码</a></li>
      </ul>
    </li>
    <li><a href="#linux-i2c-驱动">Linux I2C 驱动</a>
      <ul>
        <li><a href="#gpio-模拟">GPIO 模拟</a></li>
      </ul>
    </li>
    <li><a href="#学习文档">学习文档</a></li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&text=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&title=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&is_video=false&description=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=I2C%e6%80%bb%e7%ba%bf&body=Check out this article: https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&title=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&title=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&name=I2C%e6%80%bb%e7%ba%bf&description=%e6%97%b6%e9%92%9f%e5%bb%b6%e5%b1%95%20%e6%80%bb%e7%ba%bf%e6%8c%82%e6%ad%bb%20I2C%e5%ad%90%e7%b3%bb%e7%bb%9f%20Linux%e5%86%85%e6%a0%b8%e5%ae%9e%e7%8e%b0%20TODO%0a%e8%bd%af%e4%bb%b6%e6%a8%a1%e6%8b%9fI2C%20Master%28GPIO%e6%a8%a1%e6%8b%9f%29%20%e6%a3%80%e6%b5%8b%e6%80%bb%e7%ba%bf%e6%98%af%e5%90%a6%e7%a9%ba%e9%97%b2%20%e5%8f%91%e9%80%81START%20%2f%2f%20%e7%a1%ae%e4%bf%9d%e6%80%bb%e7%ba%bf%e7%a9%ba%e9%97%b2%20%2f%2f%20HOW%20TO%20us_delay%284%29%3b%20%2f%2f%20%e9%a2%9d%e5%a4%96%e7%9a%84%20%20SDA%3d1%3bSCL%3d1%3b%20%2f%2f%20%e6%98%af%e5%90%a6%e9%9c%80%e8%a6%81%e5%bb%b6%e6%97%b6%ef%bc%9f%e5%bb%b6%e6%97%b6%e5%a4%9a%e5%b0%91%20%20%2f%2f%20START%20%e7%ac%a6%e5%8f%b7%20SDA%3d0%3bSCL%3d1%3b%20%2f%2f%20T_hd%3bsta%20%26gt%3b%204.0%20us%20us_delay%284%29%3b%20SDA%3d0%3bSCL%3d0%3b%20%e5%8f%91%e9%80%81%20%2f%2f%20T_low%20%26gt%3b%204.7%2c%20T_high%20%26gt%3b%204.0us%20SCL%20%3d%200%3b%20us_delay%285%29%3b%20%2f%2f%20%e6%95%b0%e6%8d%ae%20SDA%20%3d%20xx%3b%20%2f%2f%20T_su%3bdat%20%26gt%3b%20250ns%20us_delay%281%29%3b%20%2f%2f%20%e6%8b%89%e9%ab%98SCL%20SCL%20%3d%201%3b%20%2f%2f%20T_high%20%26gt%3b%204.0us%20us_delay%284%29%3b%20%2f%2f%20%e6%8b%89%e4%bd%8eSCL%20SCL%20%3d%200%3b%20%2f%2f%20T_high%20%26gt%3b%204.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpsuvtk.github.io%2fposts%2f11.-i2c%25E6%2580%25BB%25E7%25BA%25BF%2f&t=I2C%e6%80%bb%e7%ba%bf">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2022  浅尝辄止 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/about">About Me</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
