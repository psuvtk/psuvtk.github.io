<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>I2C总线 - </title><meta name="author" content="Kristoffer">
<meta name="author-link" content="">
<meta name="description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO 软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START 1 2 3 4 5 6 7 8 9 10" /><meta name="keywords" content='linux' />
  <meta itemprop="name" content="I2C总线">
  <meta itemprop="description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO 软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START 1 2 3 4 5 6 7 8 9 10">
  <meta itemprop="datePublished" content="2022-10-19T20:18:47+08:00">
  <meta itemprop="dateModified" content="2022-10-19T20:18:47+08:00">
  <meta itemprop="wordCount" content="5137"><meta property="og:url" content="https://psuvtk.github.io/posts/11.-i2c%E6%80%BB%E7%BA%BF/">
  <meta property="og:title" content="I2C总线">
  <meta property="og:description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO 软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START 1 2 3 4 5 6 7 8 9 10">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-10-19T20:18:47+08:00">
    <meta property="article:modified_time" content="2022-10-19T20:18:47+08:00">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="I2C总线">
  <meta name="twitter:description" content="时钟延展 总线挂死 I2C子系统 Linux内核实现 TODO 软件模拟I2C Master(GPIO模拟) 检测总线是否空闲 发送START 1 2 3 4 5 6 7 8 9 10">
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://psuvtk.github.io/posts/11.-i2c%E6%80%BB%E7%BA%BF/" /><link rel="prev" href="https://psuvtk.github.io/posts/10.-%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/" /><link rel="next" href="https://psuvtk.github.io/posts/12.-lua/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "I2C总线",
    "inLanguage": "en",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/psuvtk.github.io\/posts\/11.-i2c%E6%80%BB%E7%BA%BF\/"
    },"genre": "posts","wordcount":  5137 ,
    "url": "https:\/\/psuvtk.github.io\/posts\/11.-i2c%E6%80%BB%E7%BA%BF\/","datePublished": "2022-10-19T20:18:47+08:00","dateModified": "2022-10-19T20:18:47+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "Kristoffer"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('light' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'light' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title=""><span class="header-title-text">Early Is On Time</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/archives/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="Search titles or contents ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="Switch Theme">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title=""><span class="header-title-text">Early Is On Time</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="Search titles or contents ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              Cancel
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/archives/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Archives</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="Switch Theme"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Collections"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>I2C总线</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      Kristoffer</span></span></div><div class="post-meta-line"><span title="published on 2022-10-19 20:18:47"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-10-19">2022-10-19</time></span>&nbsp;<span title="5137 words"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>About 5200 words</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>11 minutes</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>Contents</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#heading"></a></li>
    <li><a href="#时钟延展">时钟延展</a></li>
    <li><a href="#总线挂死">总线挂死</a></li>
    <li><a href="#i2c子系统-linux内核实现">I2C子系统 Linux内核实现</a></li>
    <li><a href="#软件模拟i2c-mastergpio模拟">软件模拟I2C Master(GPIO模拟)</a>
      <ul>
        <li><a href="#检测总线是否空闲">检测总线是否空闲</a></li>
        <li><a href="#发送start">发送START</a></li>
      </ul>
    </li>
    <li><a href="#发送">发送</a></li>
    <li><a href="#停止">停止</a></li>
    <li><a href="#gpio-模式配置stgd">GPIO 模式配置(ST/GD)</a>
      <ul>
        <li><a href="#为什么不能直接使用芯片内部的上拉电阻">为什么不能直接使用芯片内部的上拉电阻</a></li>
      </ul>
    </li>
    <li><a href="#i2c-slave">I2C Slave</a>
      <ul>
        <li><a href="#ti-参考代码">TI 参考代码</a></li>
      </ul>
    </li>
    <li><a href="#linux-i2c-驱动">Linux I2C 驱动</a>
      <ul>
        <li><a href="#gpio-模拟">GPIO 模拟</a></li>
      </ul>
    </li>
    <li><a href="#学习文档">学习文档</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="heading" class="heading-element"><span></span>
  <a href="#heading" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h2 id="时钟延展" class="heading-element"><span>时钟延展</span>
  <a href="#%e6%97%b6%e9%92%9f%e5%bb%b6%e5%b1%95" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h2 id="总线挂死" class="heading-element"><span>总线挂死</span>
  <a href="#%e6%80%bb%e7%ba%bf%e6%8c%82%e6%ad%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h2 id="i2c子系统-linux内核实现" class="heading-element"><span>I2C子系统 Linux内核实现</span>
  <a href="#i2c%e5%ad%90%e7%b3%bb%e7%bb%9f-linux%e5%86%85%e6%a0%b8%e5%ae%9e%e7%8e%b0" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p>TODO</p>
<h2 id="软件模拟i2c-mastergpio模拟" class="heading-element"><span>软件模拟I2C Master(GPIO模拟)</span>
  <a href="#%e8%bd%af%e4%bb%b6%e6%a8%a1%e6%8b%9fi2c-mastergpio%e6%a8%a1%e6%8b%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="检测总线是否空闲" class="heading-element"><span>检测总线是否空闲</span>
  <a href="#%e6%a3%80%e6%b5%8b%e6%80%bb%e7%ba%bf%e6%98%af%e5%90%a6%e7%a9%ba%e9%97%b2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><h3 id="发送start" class="heading-element"><span>发送START</span>
  <a href="#%e5%8f%91%e9%80%81start" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 确保总线空闲
</span></span></span><span class="line"><span class="cl"><span class="c1">// HOW TO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="c1">// 额外的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">SDA</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">SCL</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 是否需要延时？延时多少
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// START 符号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SDA</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">SCL</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// T_hd;sta &gt; 4.0 us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SDA</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">SCL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../../images/i2c_start.png" alt="I2C_START.png" srcset="../../images/i2c_start.png?size=small, ../../images/i2c_start.png?size=medium 1.5x, ../../images/i2c_start.png?size=large 2x" data-title="I2C_START.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="发送" class="heading-element"><span>发送</span>
  <a href="#%e5%8f%91%e9%80%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// T_low &gt; 4.7, T_high &gt; 4.0us 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SCL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">us_delay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SDA</span> <span class="o">=</span> <span class="n">xx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// T_su;dat &gt; 250ns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 拉高SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SCL</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// T_high &gt; 4.0us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 拉低SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SCL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// T_high &gt; 4.0us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="停止" class="heading-element"><span>停止</span>
  <a href="#%e5%81%9c%e6%ad%a2" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">SDA</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">SCL</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nf">us_delay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SCL</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// T_su;sto &gt; 4.0us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">SDA</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// T_hd;dat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">us_delay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../../images/i2c_stop.png" alt="I2C_START.png" srcset="../../images/i2c_stop.png?size=small, ../../images/i2c_stop.png?size=medium 1.5x, ../../images/i2c_stop.png?size=large 2x" data-title="I2C_START.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="gpio-模式配置stgd" class="heading-element"><span>GPIO 模式配置(ST/GD)</span>
  <a href="#gpio-%e6%a8%a1%e5%bc%8f%e9%85%8d%e7%bd%aestgd" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ul>
<li>
<p>输入</p>
<ul>
<li>浮空输入</li>
</ul>
</li>
<li>
<p>输出</p>
<ul>
<li>开漏输出模式</li>
<li>NOPULL 模式</li>
<li>FREQ HIGH模式</li>
</ul>
</li>
</ul>
<p>GD32、STM32在GPIO 输出配置章节有如下描述;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">开漏模式：输出控制寄存器设置为“0”时，相应引脚输出低电平；输出控制寄存器设置 为
</span></span><span class="line"><span class="cl">“1”，相应管脚处于高阻状态；</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="为什么不能直接使用芯片内部的上拉电阻" class="heading-element"><span>为什么不能直接使用芯片内部的上拉电阻</span>
  <a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e8%83%bd%e7%9b%b4%e6%8e%a5%e4%bd%bf%e7%94%a8%e8%8a%af%e7%89%87%e5%86%85%e9%83%a8%e7%9a%84%e4%b8%8a%e6%8b%89%e7%94%b5%e9%98%bb" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>内部实现的是弱上拉(40K Ohm), 不满足时序要求；
外部上拉电阻一般使用4.7K Ohm;</p>
<h2 id="i2c-slave" class="heading-element"><span>I2C Slave</span>
  <a href="#i2c-slave" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><p><img loading="lazy" src="../../images/i2c_slave_fsm.png" alt="i2c_slave_fsm.png" srcset="../../images/i2c_slave_fsm.png?size=small, ../../images/i2c_slave_fsm.png?size=medium 1.5x, ../../images/i2c_slave_fsm.png?size=large 2x" data-title="i2c_slave_fsm.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="ti-参考代码" class="heading-element"><span>TI 参考代码</span>
  <a href="#ti-%e5%8f%82%e8%80%83%e4%bb%a3%e7%a0%81" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><ul>
<li>fr2111_swi2c_master.h</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* --COPYRIGHT--,BSD
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Copyright (c) 2016, Texas Instruments Incorporated
</span></span></span><span class="line"><span class="cl"><span class="cm"> * All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Redistribution and use in source and binary forms, with or without
</span></span></span><span class="line"><span class="cl"><span class="cm"> * modification, are permitted provided that the following conditions
</span></span></span><span class="line"><span class="cl"><span class="cm"> * are met:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Redistributions of source code must retain the above copyright
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    notice, this list of conditions and the following disclaimer.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Redistributions in binary form must reproduce the above copyright
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    notice, this list of conditions and the following disclaimer in the
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    documentation and/or other materials provided with the distribution.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    its contributors may be used to endorse or promote products derived
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    from this software without specific prior written permission.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * --/COPYRIGHT--*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;msp430.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Pin Definitions. These  should be changed depending on the device that
</span></span></span><span class="line"><span class="cl"><span class="cm"> * you are using.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_SCL         BIT3
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_SDA         BIT2
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_PxDIR       P1DIR
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_PxOUT       P1OUT
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_PxIN        P1IN
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_SDA_LOW     SWI2C_PxDIR |= SWI2C_SDA
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_SCL_LOW     SWI2C_PxDIR |= SWI2C_SCL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_SCL_HIGH    SWI2C_PxDIR &amp;= ~SWI2C_SCL
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_SDA_HIGH    SWI2C_PxDIR &amp;= ~SWI2C_SDA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Defines the buffer size to be used. This will change depending on your
</span></span></span><span class="line"><span class="cl"><span class="cm"> * application and the size requirements for the transfer.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Configuration structure for performing an I2C transaction */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_SWI2C_I2CTransaction</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span>             <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint_fast16_t</span>       <span class="n">numWriteBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span>            <span class="n">writeBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint_fast16_t</span>       <span class="n">numReadBytes</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span><span class="o">*</span>            <span class="n">readBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span>                <span class="n">repeatedStart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">SWI2C_I2CTransaction</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Timer period for determining the clock rate of the I2C data clock. Note that
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the timer is sourced from SMCLK and that this number is equal to the duration
</span></span></span><span class="line"><span class="cl"><span class="cm"> * of roughly HALF a clock period. For example, if SMCLK is set to 3MHz and the
</span></span></span><span class="line"><span class="cl"><span class="cm"> * period below is set to 15, we would end up with an I2C data rate of
</span></span></span><span class="line"><span class="cl"><span class="cm"> * approximately 100Khz.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * In short, the I2C data rate frequency can be calculated by:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * I2C Data Rate =      SMCLK Frequency
</span></span></span><span class="line"><span class="cl"><span class="cm"> *                    ___________________
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *                      2 * TimerPeriod
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SWI2C_TIMER_PERIOD  15
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Macro for a timer iteration */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define TIMER_ITERATION()            TB0CCTL0 &amp;= ~(CCIFG);           \
</span></span></span><span class="line"><span class="cl"><span class="cp">                                     while(!(TB0CCTL0 &amp; CCIFG));
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Function Prototypes */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//! Initializes the software I2C master. This function takes the port
</span></span></span><span class="line"><span class="cl"><span class="c1">//! definitions that are given above and configures the device for software
</span></span></span><span class="line"><span class="cl"><span class="c1">//! I2C operation.
</span></span></span><span class="line"><span class="cl"><span class="c1">//!
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \return None
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">void</span> <span class="nf">SWI2C_initI2C</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//! Starts an I2C transaction over the configured I2C master device. Note that
</span></span></span><span class="line"><span class="cl"><span class="c1">//! this function is blocking until the transaction is completed. If a timeout
</span></span></span><span class="line"><span class="cl"><span class="c1">//! feature is required, the user should use the watchdog module of their MCU
</span></span></span><span class="line"><span class="cl"><span class="c1">//! in tandem with this function. Since the I2C slave has the ability to
</span></span></span><span class="line"><span class="cl"><span class="c1">//! &#34;clock stretch&#34; the module, care has to be taken to manage the real time
</span></span></span><span class="line"><span class="cl"><span class="c1">//!  behavior of the main application.
</span></span></span><span class="line"><span class="cl"><span class="c1">//!
</span></span></span><span class="line"><span class="cl"><span class="c1">//! &lt;hr&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">//! &lt;b&gt;Configuration options for \link SWI2C_I2CTransaction \endlink structure.&lt;/b&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">//! &lt;hr&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">//!
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \param address I2C Slave Address to communicate with.
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \param numWriteBytes Number of bytes for the master to write
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \param writeBuffer Pointer to the buffer to write
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \param numReadBytes Number of bytes to read
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \param readBuffer Pointer to the buffer to read values into
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \param repeatedStart In the event that both a read and write operation are
</span></span></span><span class="line"><span class="cl"><span class="c1">//!         requested, this bool value determines if a repeated start coniditon
</span></span></span><span class="line"><span class="cl"><span class="c1">//!         is sent out over the bus. If set to true, no I2C STOP is sent out
</span></span></span><span class="line"><span class="cl"><span class="c1">//!         after the write transaction. If set to false. After the write
</span></span></span><span class="line"><span class="cl"><span class="c1">//!         transaction completes an I2C STOP condition is sent out, and then
</span></span></span><span class="line"><span class="cl"><span class="c1">//!         the I2C read transaction is treated as a completely separate
</span></span></span><span class="line"><span class="cl"><span class="c1">//!         transaction
</span></span></span><span class="line"><span class="cl"><span class="c1">//!
</span></span></span><span class="line"><span class="cl"><span class="c1">//! Note that any order of combinations can be passed into the transaction
</span></span></span><span class="line"><span class="cl"><span class="c1">//! structure. If the user wants to only perform an I2C read, then only the
</span></span></span><span class="line"><span class="cl"><span class="c1">//! read parameters should be populated and the write parameters should be
</span></span></span><span class="line"><span class="cl"><span class="c1">//! set to 0 (or vice versa for write). The user can also specify both read
</span></span></span><span class="line"><span class="cl"><span class="c1">//! and write bytes and use the repeatedStart parameter to specify if there
</span></span></span><span class="line"><span class="cl"><span class="c1">//! is an I2C STOP between the transactions. Note that the write transaction
</span></span></span><span class="line"><span class="cl"><span class="c1">//! is always first when using this function.
</span></span></span><span class="line"><span class="cl"><span class="c1">//!
</span></span></span><span class="line"><span class="cl"><span class="c1">//! \return true if the operation passed, false otherwise. A false return
</span></span></span><span class="line"><span class="cl"><span class="c1">//!     value means that the device received a NAK where one was not expected.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SWI2C_performI2CTransaction</span><span class="p">(</span><span class="n">SWI2C_I2CTransaction</span> <span class="o">*</span><span class="n">i2cTransaction</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>fr2111_swi2c_master.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* --COPYRIGHT--,BSD
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Copyright (c) 2016, Texas Instruments Incorporated
</span></span></span><span class="line"><span class="cl"><span class="cm"> * All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Redistribution and use in source and binary forms, with or without
</span></span></span><span class="line"><span class="cl"><span class="cm"> * modification, are permitted provided that the following conditions
</span></span></span><span class="line"><span class="cl"><span class="cm"> * are met:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Redistributions of source code must retain the above copyright
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    notice, this list of conditions and the following disclaimer.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Redistributions in binary form must reproduce the above copyright
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    notice, this list of conditions and the following disclaimer in the
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    documentation and/or other materials provided with the distribution.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    its contributors may be used to endorse or promote products derived
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    from this software without specific prior written permission.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * --/COPYRIGHT--*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;fr2111_swi2c_master.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* Static Functions */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">SWI2C_readData</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">addr</span><span class="p">,</span>  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">inputArray</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="kt">uint_fast16_t</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">SWI2C_writeData</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">outputArray</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                <span class="kt">uint_fast16_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">sendStop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">SWI2C_initI2C</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Using the direction pin to control the output. When set as an input, the
</span></span></span><span class="line"><span class="cl"><span class="cm">        hardware pull-ups will take over and cause the pin to go high. When
</span></span></span><span class="line"><span class="cl"><span class="cm">        set as an output, the MSP430 will drive the lines low */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_PxOUT</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SWI2C_SCL</span> <span class="o">|</span> <span class="n">SWI2C_SDA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">PM5CTL0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LOCKLPM5</span><span class="p">;</span>                   <span class="c1">// Disable the GPIO power-on default high-impedance mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                            <span class="c1">// to activate previously configured port settings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Timer is initialized to run off SMCLK(8MHz) with frequency 200KHz */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TB0CCR0</span> <span class="o">=</span> <span class="n">SWI2C_TIMER_PERIOD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="nf">SWI2C_performI2CTransaction</span><span class="p">(</span><span class="n">SWI2C_I2CTransaction</span> <span class="o">*</span><span class="n">i2cTransaction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">numWriteBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Only skipping the stop if we have a repeated start to send */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">repeatedStart</span> <span class="o">&amp;&amp;</span> <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">numReadBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">SWI2C_writeData</span><span class="p">(</span><span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">writeBuffer</span><span class="p">,</span> <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">numWriteBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">false</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">SWI2C_writeData</span><span class="p">(</span><span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">writeBuffer</span><span class="p">,</span> <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">numWriteBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nb">true</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Next doing the read */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">numReadBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">SWI2C_readData</span><span class="p">(</span><span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">readBuffer</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">i2cTransaction</span><span class="o">-&gt;</span><span class="n">numReadBytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">SWI2C_writeData</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">outputArray</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                                <span class="kt">uint_fast16_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">sendStop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint_fast8_t</span> <span class="n">bits</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Starting the timer */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TB0CTL</span> <span class="o">=</span> <span class="n">TBSSEL_2</span> <span class="o">+</span> <span class="n">MC_1</span> <span class="o">+</span> <span class="n">TBCLR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Sending the START */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__no_operation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Next doing the control byte */</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Loop until all bits of the address byte are sent out */</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Deciding if we want to send a high or low out of the line */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>                  
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Now that we set the SDA line, we have to send out a clock pulse */</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Incrementing to the next bit and waiting for the next clock cycle */</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Detecting if we have a NAK on the bus. If the slave device NAKed the 
</span></span></span><span class="line"><span class="cl"><span class="cm">        control byte, it probably isn&#39;t there on the bus so we should send
</span></span></span><span class="line"><span class="cl"><span class="cm">         an I2C stop and return false */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">    * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SCL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SDA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">I2CWriteTransactionCleanUp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Sending out another clock cycle */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Next, let us send out all bytes in the user buffer */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">=</span> <span class="n">outputArray</span><span class="p">[</span><span class="n">ii</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* Loop until all bits of the current byte are sent out */</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Deciding if we want to send a high or low out of the line */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">{</span>                  
</span></span><span class="line"><span class="cl">                <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* Now that we set the SDA line, we send out a clock pulse */</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* Incrementing to the next bit and waiting for next clock cycle */</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* Detecting the NAK. We should break out of the send loop */</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SCL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SDA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">I2CWriteTransactionCleanUp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="cm">/* Sending out another clock cycle */</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">I2CWriteTransactionCleanUp</span><span class="p">:</span>    
</span></span><span class="line"><span class="cl">    <span class="cm">/* If the user did not request to skip, we send out the stop bit */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">((</span><span class="n">sendStop</span> <span class="o">&amp;&amp;</span> <span class="n">ii</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ii</span> <span class="o">!=</span> <span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">__no_operation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Stop the timer */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TB0CTL</span> <span class="o">=</span> <span class="n">MC_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* If all bytes were sent, return true- otherwise false. */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">bool</span> <span class="nf">SWI2C_readData</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">inputArray</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="kt">uint_fast16_t</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint_fast8_t</span> <span class="n">bits</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint16_t</span> <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Starting the timer */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TB0CTL</span> <span class="o">=</span> <span class="n">TBSSEL_2</span> <span class="o">+</span> <span class="n">MC_1</span> <span class="o">+</span> <span class="n">TBCLR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Sending the START */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__no_operation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Next doing the control byte */</span>
</span></span><span class="line"><span class="cl">    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Loop until all bits of the address byte are sent out */</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Deciding if we want to send a high or low out of the line */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="p">{</span>                  
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>                 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Now that we set the SDA line, we have to send out a clock pulse */</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Incrementing to the next bit and waiting for the next clock cycle */</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Detecting if we have a NAK on the bus. If the slave device NAKed the 
</span></span></span><span class="line"><span class="cl"><span class="cm">        control byte, it probably isn&#39;t there on the bus so we should send
</span></span></span><span class="line"><span class="cl"><span class="cm">         an I2C stop and return false */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SDA</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">I2CReadTransactionCleanUp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Next, we want to read out all of the data requested */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span><span class="n">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">ii</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SCL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Setup the read variables */</span>
</span></span><span class="line"><span class="cl">        <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bits</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="cm">/* Sending out another clock cycle */</span>
</span></span><span class="line"><span class="cl">         <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">         <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Loop to read until all bits have been read */</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Priming our temporary variable and sending a clock pulse */</span>
</span></span><span class="line"><span class="cl">            <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="cm">/* If the data line is high, recording that */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SDA</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">temp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="cm">/* Send out another clock cycle and decrement our counter */</span>
</span></span><span class="line"><span class="cl">            <span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Storing the data off */</span>
</span></span><span class="line"><span class="cl">        <span class="n">inputArray</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Now the master needs to send out the ACK */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl">        	<span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">        * Waiting for our clock line to go high if the slave is stretching
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">SWI2C_PxIN</span> <span class="o">&amp;</span> <span class="n">SWI2C_SCL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">I2CReadTransactionCleanUp</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Sending out the stop bit */</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_LOW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SCL_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__no_operation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">SWI2C_SDA_HIGH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">TIMER_ITERATION</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Stop the timer */</span>
</span></span><span class="line"><span class="cl">    <span class="n">TB0CTL</span> <span class="o">=</span> <span class="n">MC_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* If all bytes were read, return true- otherwise false. */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">ii</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>FR2111_SW_I2C_Slave.c</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* --COPYRIGHT--,BSD
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Copyright (c) 2016, Texas Instruments Incorporated
</span></span></span><span class="line"><span class="cl"><span class="cm"> * All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Redistribution and use in source and binary forms, with or without
</span></span></span><span class="line"><span class="cl"><span class="cm"> * modification, are permitted provided that the following conditions
</span></span></span><span class="line"><span class="cl"><span class="cm"> * are met:
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Redistributions of source code must retain the above copyright
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    notice, this list of conditions and the following disclaimer.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Redistributions in binary form must reproduce the above copyright
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    notice, this list of conditions and the following disclaimer in the
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    documentation and/or other materials provided with the distribution.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * *  Neither the name of Texas Instruments Incorporated nor the names of
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    its contributors may be used to endorse or promote products derived
</span></span></span><span class="line"><span class="cl"><span class="cm"> *    from this software without specific prior written permission.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &#34;AS IS&#34;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
</span></span></span><span class="line"><span class="cl"><span class="cm"> * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * --/COPYRIGHT--*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1">//  MSP430FR2111 Software I2C Slave
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  Description: This demo connects two MSP430&#39;s via the I2C bus. The master is
</span></span></span><span class="line"><span class="cl"><span class="c1">//  MSP430FR2311 with hardware I2C(eUSCI_B0). The slave is MSP430FR2111 using GPIOs
</span></span></span><span class="line"><span class="cl"><span class="c1">//  to implement software I2C. The master write to and read from the slave.
</span></span></span><span class="line"><span class="cl"><span class="c1">//  This is the slave code.
</span></span></span><span class="line"><span class="cl"><span class="c1">//  MCLK = SMCLK = 8MHz.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//    *****used with &#34;FR2311_HW_I2C_Master.c&#34;****
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                /|\  /|\
</span></span></span><span class="line"><span class="cl"><span class="c1">//               MSP430FR2311      10k  10k     MSP430FR2111
</span></span></span><span class="line"><span class="cl"><span class="c1">//                   master         |    |        slave
</span></span></span><span class="line"><span class="cl"><span class="c1">//             -----------------   |    |   -----------------
</span></span></span><span class="line"><span class="cl"><span class="c1">//            |     P1.2/UCB0SDA|&lt;-|----|-&gt;|P2.0(SW I2C)     |
</span></span></span><span class="line"><span class="cl"><span class="c1">//            |                 |  |       |                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//            |                 |  |       |                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//            |     P1.3/UCB0SCL|&lt;-|------&gt;|P1.0(SW I2C)     |
</span></span></span><span class="line"><span class="cl"><span class="c1">//            |                 |          |                 |
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//   Texas Instruments Inc.
</span></span></span><span class="line"><span class="cl"><span class="c1">//   June. 2016
</span></span></span><span class="line"><span class="cl"><span class="c1">//******************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;msp430.h&gt; </span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SCL BIT0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define SDA BIT0
</span></span></span><span class="line"><span class="cl"><span class="cp">#define I2COA 0x0A               </span><span class="c1">// Slave address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define I2C_START     1          </span><span class="c1">// Start condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define I2C_STOP      2          </span><span class="c1">// Stop condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W1LH      3          </span><span class="c1">// Bit 1 (first clk rising edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W1HL      4          </span><span class="c1">// Bit 1 (first clk falling edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W2to6LH   5          </span><span class="c1">// Bit 2-6(2nd~6th  clk rising edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W7LH      6          </span><span class="c1">// Bit 7 (7th  clk rising edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W8LH      7          </span><span class="c1">// Bit 8 (8th  clk rising edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W8HL      8          </span><span class="c1">// Set ACK (8th  clk falling edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_W9HL      9          </span><span class="c1">// Re-init R4 (9th  clk falling edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_R1HL      10         </span><span class="c1">// Bit 1 (first clk falling edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_R1LH      11         </span><span class="c1">// Bit 1 (first clk rising edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_R2to8HL   12         </span><span class="c1">// Bit 2-8 (2nd~8th clk falling edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_R9HL      13         </span><span class="c1">// Free SDA (9th clk falling edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define SCL_R9LH      14         </span><span class="c1">// Check ACK (9th clk rising edge)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define MCLK_FREQ_MHZ 8          </span><span class="c1">// MCLK = 8MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ram_data</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i2c_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">I2C_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cnt_2to6</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cnt_2to8</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">RW_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ram_cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">InitBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">INIT_PORT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Software_Trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">WDTCTL</span> <span class="o">=</span> <span class="n">WDTPW</span> <span class="o">|</span> <span class="n">WDTHOLD</span><span class="p">;</span>	            <span class="c1">// Stop watchdog timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">__bis_SR_register</span><span class="p">(</span><span class="n">SCG0</span><span class="p">);</span>                <span class="c1">// Disable FLL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CSCTL3</span> <span class="o">=</span> <span class="n">SELREF__REFOCLK</span><span class="p">;</span>               <span class="c1">// Set REFO as FLL reference source
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CSCTL1</span> <span class="o">=</span> <span class="n">DCOFTRIMEN_1</span> <span class="o">|</span> <span class="n">DCOFTRIM0</span> <span class="o">|</span> <span class="n">DCOFTRIM1</span> <span class="o">|</span> <span class="n">DCORSEL_3</span><span class="p">;</span><span class="c1">// DCOFTRIM=3, DCO Range = 8MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CSCTL2</span> <span class="o">=</span> <span class="n">FLLD_0</span> <span class="o">+</span> <span class="mi">243</span><span class="p">;</span>                  <span class="c1">// DCODIV = 8MHz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">__delay_cycles</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__bic_SR_register</span><span class="p">(</span><span class="n">SCG0</span><span class="p">);</span>                <span class="c1">// Enable FLL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">Software_Trim</span><span class="p">();</span>                        <span class="c1">// Software Trim to get the best DCOFTRIM value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CSCTL4</span> <span class="o">=</span> <span class="n">SELMS__DCOCLKDIV</span> <span class="o">|</span> <span class="n">SELA__REFOCLK</span><span class="p">;</span> <span class="c1">// set default REFO(~32768Hz) as ACLK source, ACLK = 32768Hz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                               <span class="c1">// default DCODIV as MCLK and SMCLK source
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">InitBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">INIT_PORT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">__enable_interrupt</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">InitBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ram_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Set SCL and SDA to inputs
</span></span></span><span class="line"><span class="cl"><span class="c1">// SDA interrupts on high-to-low transition
</span></span></span><span class="line"><span class="cl"><span class="c1">// SCL interrupts on low-to-high transition
</span></span></span><span class="line"><span class="cl"><span class="c1">// initially, just SDA interrupt is set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">INIT_PORT</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">P2OUT</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>    <span class="c1">// When the pins are set to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P1OUT</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// output, low level should be seen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P1DIR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// SCL and SDA defined as inputs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P2DIR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">P2IES</span> <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>     <span class="c1">//INT. on high-to-low transition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P1IES</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// INT. on low-to-high transition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P1IE</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// Disable SCL interrupt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P2IE</span>  <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>     <span class="c1">// Enable SDA interrupt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// Reset interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">P2IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PM5CTL0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LOCKLPM5</span><span class="p">;</span>  <span class="c1">// Disable the GPIO power-on default high-impedance mode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	                       <span class="c1">// to activate previously configured port settings
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SDA(Port 2) interrupt service routine
</span></span></span><span class="line"><span class="cl"><span class="c1">// Port 2 ISR, check Start or Stop condition from P2.0 and P1.0
</span></span></span><span class="line"><span class="cl"><span class="c1">// Or it can check I/O interrupt from other P2 pins with interrupt function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma vector=PORT2_VECTOR
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">__interrupt</span> <span class="kt">void</span> <span class="nf">Port_2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#elif defined(__GNUC__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="nf">interrupt</span><span class="p">(</span><span class="n">PORT2_VECTOR</span><span class="p">)))</span> <span class="nf">Port_2</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#error Compiler not supported!
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">((</span><span class="n">P1IN</span> <span class="o">&amp;</span> <span class="n">SCL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">P2IFG</span> <span class="o">&amp;</span> <span class="n">SDA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">P2IES</span> <span class="o">&amp;</span> <span class="n">SDA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">I2C_START</span><span class="p">;</span> <span class="c1">// I2C start condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">I2C_STOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">P2IFG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>          <span class="c1">// Clear INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span><span class="p">(</span><span class="n">I2C_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">I2C_START</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>  <span class="c1">// P1.0 clear INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IE</span> <span class="o">|=</span> <span class="n">SCL</span><span class="p">;</span>    <span class="c1">// P1.0 INT enable for SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IES</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>  <span class="c1">// P2.0 set to rising edge for SDA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>  <span class="c1">// P2.0 clear INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IE</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">SDA</span><span class="p">;</span>  <span class="c1">// P2.0 INT disable for SDA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W1LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">I2C_STOP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nf">INIT_PORT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// Reset I2CDATA for addr detect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">RW_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// Reset RW_flag for addr detect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ram_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// Reset buffer pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCL(Port 1) interrupt service routine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#if defined(__TI_COMPILER_VERSION__) || defined(__IAR_SYSTEMS_ICC__)
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma vector=PORT1_VECTOR
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">__interrupt</span> <span class="kt">void</span> <span class="nf">Port_1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#elif defined(__GNUC__)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">void</span> <span class="nf">__attribute__</span> <span class="p">((</span><span class="nf">interrupt</span><span class="p">(</span><span class="n">PORT1_VECTOR</span><span class="p">)))</span> <span class="nf">Port_1</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp">#error Compiler not supported!
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span><span class="p">(</span><span class="n">I2C_state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W1LH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IES</span> <span class="o">|=</span> <span class="n">SCL</span><span class="p">;</span>      <span class="c1">// Set falling edge for SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">P2IN</span> <span class="o">&amp;</span> <span class="n">SDA</span><span class="p">)</span>     <span class="c1">// Check SDA and update i2c_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">i2c_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="c1">// Shift SDA bit into the buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">i2c_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>     <span class="c1">// Reset SCL interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>     <span class="c1">// Clear flag, FOR STP_CON DETECT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IE</span> <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>       <span class="c1">// Enable SDA INT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W1HL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W1HL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IES</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">SCL</span><span class="p">;</span>    <span class="c1">// Set rising edge for SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>     <span class="c1">// Reset SCL interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IE</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>      <span class="c1">// 1st FALLING SCL TO disable SDA INT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W2to6LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W2to6LH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>     <span class="c1">// Reset interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">i2c_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">P2IN</span> <span class="o">&amp;</span> <span class="n">SDA</span><span class="p">)</span>     <span class="c1">// Check SDA and and update i2c_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">i2c_data</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">cnt_2to6</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>   <span class="c1">// 5bits(bit2 to bit6)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">cnt_2to6</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">cnt_2to6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// Reset counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W7LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W7LH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>     <span class="c1">// Reset interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">i2c_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">P2IN</span> <span class="o">&amp;</span> <span class="n">SDA</span><span class="p">)</span>     <span class="c1">// Check SDA and and update i2c_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">i2c_data</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">((</span><span class="n">RW_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i2c_data</span> <span class="o">!=</span> <span class="n">I2COA</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">I2C_STOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W8LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W8LH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IES</span> <span class="o">|=</span> <span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Set falling edge for SCL.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>       <span class="c1">// Reset interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">RW_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">P2IN</span> <span class="o">&amp;</span> <span class="n">SDA</span><span class="p">)</span>   <span class="c1">// Check SDA and and update i2c_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">RW_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Read CMD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">else</span>
</span></span><span class="line"><span class="cl">				<span class="n">RW_flag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="c1">// Write CMD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">i2c_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span><span class="p">(</span><span class="n">P2IN</span> <span class="o">&amp;</span> <span class="n">SDA</span><span class="p">)</span>   <span class="c1">// Check SDA and and update i2c_data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">i2c_data</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W8HL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W8HL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P2DIR</span> <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>        <span class="c1">// Output &#34;0&#34; for SDA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>       <span class="c1">//Reset SCL interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">RW_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">i2c_data</span> <span class="o">=</span> <span class="n">ram_data</span><span class="p">[</span><span class="n">ram_cnt</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">			<span class="n">ram_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ram_cnt</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_R1HL</span><span class="p">;</span><span class="c1">// Go to read state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">RW_flag</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">RW_flag</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W9HL</span><span class="p">;</span><span class="c1">// Go to write state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">RW_flag</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">ram_data</span><span class="p">[</span><span class="n">ram_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">i2c_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">ram_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ram_cnt</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W9HL</span><span class="p">;</span><span class="c1">// Go to write state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">I2C_STOP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_W9HL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P2DIR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>        <span class="c1">// Release SDA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IES</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Set rising edge for SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Reset interrupt flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W1LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_R1HL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IES</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Set rising edge SCL for SCL_R1LH
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">i2c_data</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">P2DIR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>    <span class="c1">// SDA = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">P2DIR</span> <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>     <span class="c1">// SDA = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">i2c_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">SCL</span><span class="p">;</span>       <span class="c1">// Clear SCL INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IE</span>  <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">SDA</span><span class="p">;</span>       <span class="c1">// Disable SDA INT, NO STP CON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_R1LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_R1LH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IES</span> <span class="o">|=</span> <span class="n">SCL</span><span class="p">;</span>         <span class="c1">// Set falling edge for SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Clear SCL INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>        <span class="c1">// Clear SDA INT Flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IE</span> <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>          <span class="c1">// Enable SDA INT for STOP CON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_R2to8HL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_R2to8HL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">i2c_data</span> <span class="o">&amp;</span> <span class="n">BIT7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">P2DIR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>    <span class="c1">// SDA = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">P2DIR</span> <span class="o">|=</span> <span class="n">SDA</span><span class="p">;</span>     <span class="c1">// SDA = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">i2c_data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">SCL</span><span class="p">;</span>       <span class="c1">// Clear SCL INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P2IE</span>  <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">SDA</span><span class="p">;</span>       <span class="c1">// Disable SDA INT, NO STP CON
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span><span class="p">(</span><span class="n">cnt_2to8</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">cnt_2to8</span><span class="o">++</span><span class="p">;</span>       <span class="c1">// 7bits(bit2 to bit8)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">cnt_2to8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">// Clear counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_R9HL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_R9HL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">P2DIR</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDA</span><span class="p">;</span>        <span class="c1">// Release SDA
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IES</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Set Rising edge of SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>        <span class="c1">// Clear SCL INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_R9LH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SCL_R9LH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="n">P2IN</span> <span class="o">&amp;</span> <span class="n">SDA</span><span class="p">)</span>        <span class="c1">// NACK_READ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">P1IES</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// Set rising edge of SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// Clear SCL INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_W1LH</span><span class="p">;</span> <span class="c1">// Go to SCL_W1LH to detect stop condition
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>                  <span class="c1">// ACK_READ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">P1IES</span> <span class="o">|=</span> <span class="n">SCL</span><span class="p">;</span>     <span class="c1">// Set falling edge of SCL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">P1IFG</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCL</span><span class="p">;</span>    <span class="c1">// Clear SCL INT flag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">i2c_data</span> <span class="o">=</span> <span class="n">ram_data</span><span class="p">[</span><span class="n">ram_cnt</span><span class="p">];</span> <span class="c1">// Move out next byte from RAM buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">ram_cnt</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">ram_cnt</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">I2C_state</span> <span class="o">=</span> <span class="n">SCL_R1HL</span><span class="p">;</span><span class="c1">// Go to read state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">I2C_STOP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nf">INIT_PORT</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="c1">// Reset I2CDATA for addr detect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">RW_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// Reset RW_flag for addr detect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ram_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="c1">// Reset buffer pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="linux-i2c-驱动" class="heading-element"><span>Linux I2C 驱动</span>
  <a href="#linux-i2c-%e9%a9%b1%e5%8a%a8" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><h3 id="gpio-模拟" class="heading-element"><span>GPIO 模拟</span>
  <a href="#gpio-%e6%a8%a1%e6%8b%9f" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h3><p>算法: linux-6.1-rc2\drivers\i2c\algos\i2c-algo-bit.c
总线: linux-6.1-rc2\drivers\i2c\busses\i2c-gpio.c</p>
<h2 id="学习文档" class="heading-element"><span>学习文档</span>
  <a href="#%e5%ad%a6%e4%b9%a0%e6%96%87%e6%a1%a3" class="heading-mark">
    <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg>
  </a>
</h2><ol>
<li>UM10204(I2C-bus specification and user manual) Texas Instruments</li>
<li>SPRABJ6(Software Implementation of PMBus Over I2C for TMS320F2803x)</li>
<li>从机状态机: SLAA703A(Software I2C on MSP430™ MCUs)</li>
</ol>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="Updated on 2022-10-19 20:18:47">Updated on 2022-10-19&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/11.-i2c%E6%80%BB%E7%BA%BF/index.md" title="Read Markdown" class="link-to-markdown">Read Markdown</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="Share on X" data-sharer="twitter" data-url="https://psuvtk.github.io/posts/11.-i2c%E6%80%BB%E7%BA%BF/" data-title="I2C总线"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://psuvtk.github.io/posts/11.-i2c%E6%80%BB%E7%BA%BF/"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="https://psuvtk.github.io/posts/11.-i2c%E6%80%BB%E7%BA%BF/" data-title="I2C总线"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/10.-%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/" class="post-nav-item" rel="prev" title="SPI总线"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>SPI总线</a>
      <a href="/posts/12.-lua/" class="post-nav-item" rel="next" title="Lua">Lua<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article>

  <aside class="toc" id="toc-auto" aria-label="Contents"><h2 class="toc-title">Contents&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.132.2"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> | Theme - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.9"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2025</span><span class="author" itemprop="copyrightHolder">
              <a href="/">Kristoffer</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="Back to Top"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">This website works best with JavaScript enabled.</div>
  </noscript>
</div><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","editLockTitle":"Lock editable code block","editUnLockTitle":"Unlock editable code block","editable":true,"maxShownLines":99},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"version":"v0.3.9"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
